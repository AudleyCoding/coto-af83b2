<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shopping List</title>
    
    <!-- iOS Home Screen App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Shopping List">
    
    <!-- App Icon for iOS Home Screen (using emoji as data URI) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%234F46E5' rx='20'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>ðŸ›’</text></svg>">
    
    <!-- Hide number input spinner arrows -->
    <style>
        /* Chrome, Safari, Edge, Opera */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#4F46E5">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // Initial recipe data - this will be loaded from memory storage
        const INITIAL_RECIPES = [
          {
            id: 1,
            name: "Ayam Goreng Paste",
            yieldUnit: "batch",
            notes: "",
            isFavorite: false,
            ingredients: [
              { name: "shallot paste", quantity: 800.0, unit: "g", substitution: "", price: null },
              { name: "garlic paste", quantity: 150.0, unit: "g", substitution: "", price: null },
              { name: "galangal paste", quantity: 500.0, unit: "g", substitution: "", price: null },
              { name: "candlenuts", quantity: 140.0, unit: "g", substitution: "", price: null },
              { name: "coriander powder", quantity: 50.0, unit: "g" },
              { name: "white pepper powder", quantity: 50.0, unit: "g" },
              { name: "lemongrass", quantity: 30.0, unit: "pcs" },
              { name: "ginger paste", quantity: 400.0, unit: "g" },
              { name: "salt", quantity: 75.0, unit: "g" },
              { name: "turmeric powder", quantity: 200.0, unit: "g" }
            ]
          },
          {
            id: 2,
            name: "Bumbu Coto Paste",
            yieldUnit: "g",
            yieldQuantity: 5600,
            notes: "",
            isFavorite: false,
            ingredients: [
              { name: "shallot paste", quantity: 2400.0, unit: "g" },
              { name: "garlic paste", quantity: 1200.0, unit: "g" },
              { name: "lemongrass paste", quantity: 1200.0, unit: "g" },
              { name: "coto spice pack", quantity: 1.0, unit: "bag" },
              { name: "cinnamon sticks", quantity: 2.0, unit: "pcs" },
              { name: "coconut palm sugar(6 pucks)", quantity: 360.0, unit: "g" },
              { name: "galangal paste", quantity: 500.0, unit: "g" },
              { name: "ginger paste", quantity: 250.0, unit: "g" },
              { name: "kaffir lime leaves 15 (small to med)", quantity: null, unit: "g" },
              { name: "bay leaves 10 (big)", quantity: null, unit: "g" },
              { name: "pandan leaves", quantity: 1.0, unit: "pcs" },
              { name: "oil", quantity: 500.0, unit: "ml" }
            ]
          },
          {
            id: 3,
            name: "Ayam Bakar Marinade",
            yieldUnit: "batch",
            notes: "",
            isFavorite: false,
            ingredients: [
              { name: "ayam bakar paste", quantity: 1.0, unit: "batch" },
              { name: "ayam bakar spice pack", quantity: 1.0, unit: "bag" },
              { name: "oil", quantity: 300.0, unit: "ml" },
              { name: "honey", quantity: 40.0, unit: "g" },
              { name: "ketchup manis", quantity: 220.0, unit: "g" },
              { name: "coconut water", quantity: 500.0, unit: "ml" },
              { name: "coconut milk", quantity: 500.0, unit: "ml" },
              { name: "lemon leaves 3-4", quantity: null, unit: "" },
              { name: "bay leaves 3-4", quantity: null, unit: "" },
              { name: "pandan leaf", quantity: 1.0, unit: "pcs" },
              { name: "tamarind paste", quantity: 1.0, unit: "Tbsp" },
              { name: "chilies, chopped", quantity: 180.0, unit: "g" }
            ]
          }
        ];

        // Simple icon components
        const ShoppingCart = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        );

        const Plus = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
          </svg>
        );

        const Minus = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
          </svg>
        );

        const Edit = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        );

        const Trash = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        );

        const X = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        );

        const Settings = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        );

        const RefreshCw = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        );

        const Star = ({ className, filled }) => (
          <svg className={className} fill={filled ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        );

        const Copy = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        );

        const Moon = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
        );

        const Sun = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        );

        const Download = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
        );

        const Upload = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L9 8m4-4v12" />
          </svg>
        );

        const ChevronDown = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        );

        const ShoppingBag = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
        );

        const TrendingUp = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
          </svg>
        );

        const BarChart2 = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        );

        const ArrowLeft = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        );

        const DollarSign = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        );

        const Store = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        );

        const HelpCircle = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        );

        const Save = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
          </svg>
        );

        const Share = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
        );

        const CheckCircle = ({ className }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        );

        // Helper function to format amounts without unnecessary decimals
        const formatAmount = (amount) => {
          return Number.isInteger(amount) ? amount.toString() : amount.toFixed(1);
        };

        // Price Chart Component using Chart.js
        function PriceChart({ chartData, minPrice, maxPrice, darkMode }) {
          const canvasRef = useRef(null);
          const chartInstanceRef = useRef(null);

          useEffect(() => {
            if (!canvasRef.current || chartData.length === 0) return;

            // Destroy previous chart instance
            if (chartInstanceRef.current) {
              chartInstanceRef.current.destroy();
            }

            const ctx = canvasRef.current.getContext('2d');
            
            // Prepare data for Chart.js
            const labels = chartData.map(d => d.date);
            const prices = chartData.map(d => d.price);
            
            // Find indices of min and max prices for highlighting
            const minIndex = prices.indexOf(minPrice);
            const maxIndex = prices.indexOf(maxPrice);
            
            // Create point background colors (highlight min/max)
            const pointBackgroundColors = prices.map((price, index) => {
              if (price === minPrice) return '#10b981'; // green
              if (price === maxPrice) return '#ef4444'; // red
              return '#3b82f6'; // blue
            });
            
            const pointRadius = prices.map((price, index) => {
              if (price === minPrice || price === maxPrice) return 6;
              return 4;
            });

            chartInstanceRef.current = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Price (NT$)',
                  data: prices,
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  borderWidth: 2,
                  pointBackgroundColor: pointBackgroundColors,
                  pointBorderColor: pointBackgroundColors,
                  pointRadius: pointRadius,
                  pointHoverRadius: 8,
                  tension: 0.2,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false,
                },
                plugins: {
                  legend: {
                    display: true,
                    labels: {
                      color: darkMode ? '#9ca3af' : '#6b7280',
                      font: {
                        size: 12
                      }
                    }
                  },
                  tooltip: {
                    enabled: true,
                    backgroundColor: darkMode ? '#1f2937' : '#ffffff',
                    titleColor: darkMode ? '#9ca3af' : '#6b7280',
                    bodyColor: darkMode ? '#f3f4f6' : '#111827',
                    borderColor: darkMode ? '#374151' : '#e5e7eb',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                      label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                          label += ': ';
                        }
                        label += 'NT$' + context.parsed.y.toFixed(2);
                        
                        // Add annotation for min/max
                        if (context.parsed.y === minPrice) {
                          label += ' (Lowest)';
                        } else if (context.parsed.y === maxPrice) {
                          label += ' (Highest)';
                        }
                        
                        return label;
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    grid: {
                      color: darkMode ? '#374151' : '#e5e7eb',
                      drawBorder: false
                    },
                    ticks: {
                      color: darkMode ? '#9ca3af' : '#6b7280',
                      font: {
                        size: 11
                      }
                    }
                  },
                  y: {
                    beginAtZero: false,
                    grid: {
                      color: darkMode ? '#374151' : '#e5e7eb',
                      drawBorder: false
                    },
                    ticks: {
                      color: darkMode ? '#9ca3af' : '#6b7280',
                      font: {
                        size: 11
                      },
                      callback: function(value) {
                        return 'NT$' + value.toFixed(0);
                      }
                    }
                  }
                }
              }
            });

            // Cleanup function
            return () => {
              if (chartInstanceRef.current) {
                chartInstanceRef.current.destroy();
              }
            };
          }, [chartData, minPrice, maxPrice, darkMode]);

          return (
            <div className={`rounded-lg shadow-sm border p-6 mb-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
              <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                Price Trend (Last 12 Months)
              </h2>
              <div style={{ position: 'relative', height: '300px', width: '100%' }}>
                <canvas ref={canvasRef}></canvas>
              </div>
            </div>
          );
        }

        function ShoppingAggregator() {
          const [recipes, setRecipes] = useState([]);
          const [selectedRecipes, setSelectedRecipes] = useState({});
          const [purchasedItems, setPurchasedItems] = useState(new Set());
          const [planToBuyItems, setPlanToBuyItems] = useState(new Set());
          const [showManageRecipes, setShowManageRecipes] = useState(false);
          const [editingRecipe, setEditingRecipe] = useState(null);
          const [showRecipeForm, setShowRecipeForm] = useState(false);
          const [expandedRecipes, setExpandedRecipes] = useState({});
          const [searchQuery, setSearchQuery] = useState('');
          const [ingredientPrices, setIngredientPrices] = useState({});
          const [lastKnownPrices, setLastKnownPrices] = useState({});
          const [darkMode, setDarkMode] = useState(false);
          const [collapsedSections, setCollapsedSections] = useState({});
          const [showPriceHistory, setShowPriceHistory] = useState(false);
          const [selectedIngredient, setSelectedIngredient] = useState(null);
          const [priceHistoryData, setPriceHistoryData] = useState({});
          const [priceHistorySearchQuery, setPriceHistorySearchQuery] = useState('');
          const [priceHistorySortBy, setPriceHistorySortBy] = useState('newest'); // 'newest' or 'alphabetical'
          const [editingPriceEntry, setEditingPriceEntry] = useState(null); // {ingredientName, entryIndex, date, price, packageQuantity, packageUnit}
          const [addingPriceEntry, setAddingPriceEntry] = useState(null); // {ingredientName, date, price, packageQuantity, packageUnit}
          const [quickAddItems, setQuickAddItems] = useState([]);
          const [quickAddInput, setQuickAddInput] = useState('');
          const [showPriceManagement, setShowPriceManagement] = useState(false);
          const [priceSearchQuery, setPriceSearchQuery] = useState('');
          const [packageUnits, setPackageUnits] = useState(['g', 'kg', 'æ–¤', 'ml', 'L', 'pcs', 'pack', 'bag', 'bottle', 'can']);
          const [showScrollTop, setShowScrollTop] = useState(false);
          const [showIngredientSources, setShowIngredientSources] = useState(false);
          const [selectedIngredientForSources, setSelectedIngredientForSources] = useState(null);
          const [expandedPriceInputs, setExpandedPriceInputs] = useState(new Set());
          
          // Shopping Trip History
          const [shoppingTrips, setShoppingTrips] = useState([]);
          const [showTripHistory, setShowTripHistory] = useState(false);
          const [showQuickLog, setShowQuickLog] = useState(false);
          const [showManageVendors, setShowManageVendors] = useState(false);
          const [showHelp, setShowHelp] = useState(false);
          const [scrollPositionBeforeHelp, setScrollPositionBeforeHelp] = useState(0);
          const [vendors, setVendors] = useState(['Street Market - Veggies', 'Street Market - Vietnamese', 'Street Market - Shallot', 'Big King', 'RT-Mart']);
          const [vendorEditText, setVendorEditText] = useState('');
          const [tripTotal, setTripTotal] = useState('');
          const [selectedVendor, setSelectedVendor] = useState('');
          const [tripDate, setTripDate] = useState(new Date().toISOString().split('T')[0]);
          const [loggedItems, setLoggedItems] = useState(new Set()); // Track items already saved to a trip
          const [editingTrip, setEditingTrip] = useState(null); // {id, vendor, total, date} for editing

          // Load dark mode preference on mount
          useEffect(() => {
            const stored = localStorage.getItem('darkMode');
            if (stored) {
              setDarkMode(stored === 'true');
            }
          }, []);

          // Save dark mode preference
          useEffect(() => {
            localStorage.setItem('darkMode', darkMode.toString());
          }, [darkMode]);

          // Load recipes from memory on mount
          useEffect(() => {
            const stored = localStorage.getItem('restaurantRecipes');
            if (stored && stored !== 'null' && stored !== '[]') {
              try {
                const parsedRecipes = JSON.parse(stored);
                if (parsedRecipes && parsedRecipes.length > 0) {
                  setRecipes(parsedRecipes);
                } else {
                  console.log('No recipes in localStorage, loading defaults');
                  setRecipes(INITIAL_RECIPES);
                }
              } catch (e) {
                console.error('Error parsing recipes, loading defaults:', e);
                setRecipes(INITIAL_RECIPES);
              }
            } else {
              console.log('No recipes stored, loading defaults');
              setRecipes(INITIAL_RECIPES);
            }
          }, []);

          // Load selected recipes from localStorage
          useEffect(() => {
            const stored = localStorage.getItem('selectedRecipes');
            if (stored) {
              try {
                setSelectedRecipes(JSON.parse(stored));
              } catch (e) {
                console.error('Failed to load selected recipes:', e);
              }
            }
          }, []);

          // Save recipes to memory whenever they change
          useEffect(() => {
            if (recipes.length > 0) {
              localStorage.setItem('restaurantRecipes', JSON.stringify(recipes));
            }
          }, [recipes]);

          // Save selected recipes to localStorage whenever they change
          useEffect(() => {
            localStorage.setItem('selectedRecipes', JSON.stringify(selectedRecipes));
          }, [selectedRecipes]);

          // Load last known prices from localStorage
          useEffect(() => {
            const stored = localStorage.getItem('lastKnownPrices');
            if (stored) {
              try {
                setLastKnownPrices(JSON.parse(stored));
              } catch (e) {
                console.error('Failed to load last known prices:', e);
              }
            }
          }, []);

          // Load price history from localStorage
          useEffect(() => {
            const stored = localStorage.getItem('priceHistoryData');
            if (stored) {
              try {
                setPriceHistoryData(JSON.parse(stored));
              } catch (e) {
                console.error('Failed to load price history:', e);
              }
            }
          }, []);
 // Run when lastKnownPrices loads

          // Load quick add items from localStorage
          useEffect(() => {
            const stored = localStorage.getItem('quickAddItems');
            if (stored) {
              try {
                setQuickAddItems(JSON.parse(stored));
              } catch (e) {
                console.error('Failed to load quick add items:', e);
              }
            }
          }, []);

          // Save quick add items to localStorage whenever they change
          useEffect(() => {
            localStorage.setItem('quickAddItems', JSON.stringify(quickAddItems));
          }, [quickAddItems]);

          // Load and save package units
          useEffect(() => {
            const stored = localStorage.getItem('packageUnits');
            if (stored) {
              try {
                setPackageUnits(JSON.parse(stored));
              } catch (e) {
                console.error('Failed to load package units:', e);
              }
            }
          }, []);

          useEffect(() => {
            localStorage.setItem('packageUnits', JSON.stringify(packageUnits));
          }, [packageUnits]);

          // Scroll to top button visibility
          useEffect(() => {
            const handleScroll = () => {
              setShowScrollTop(window.scrollY > 500);
            };
            window.addEventListener('scroll', handleScroll);
            return () => window.removeEventListener('scroll', handleScroll);
          }, []);

          // Load and save shopping trips
          useEffect(() => {
            const stored = localStorage.getItem('shoppingTrips');
            if (stored) {
              try {
                setShoppingTrips(JSON.parse(stored));
              } catch (e) {
                console.error('Failed to load shopping trips:', e);
              }
            }
          }, []);

          useEffect(() => {
            localStorage.setItem('shoppingTrips', JSON.stringify(shoppingTrips));
          }, [shoppingTrips]);

          // Load and save vendors
          useEffect(() => {
            const stored = localStorage.getItem('vendors');
            if (stored) {
              try {
                setVendors(JSON.parse(stored));
              } catch (e) {
                console.error('Failed to load vendors:', e);
              }
            }
          }, []);

          useEffect(() => {
            localStorage.setItem('vendors', JSON.stringify(vendors));
          }, [vendors]);

          // Sync recipe locations with vendors list
          useEffect(() => {
            const locationSet = new Set();
            recipes.forEach(r => {
              r.ingredients.forEach(ing => {
                if (ing.location && ing.location.trim()) {
                  locationSet.add(ing.location.trim());
                }
              });
            });
            
            const locationsFromRecipes = Array.from(locationSet);
            const newVendors = [...vendors];
            let hasChanges = false;
            
            // Add recipe locations that aren't in vendors
            locationsFromRecipes.forEach(loc => {
              if (!newVendors.includes(loc)) {
                newVendors.push(loc);
                hasChanges = true;
              }
            });
            
            if (hasChanges) {
              setVendors(newVendors.sort());
            }
          }, [recipes]); // Only depend on recipes, not vendors, to avoid infinite loop

          // Auto-suggest vendor and calculate total when Quick Log opens
          useEffect(() => {
            if (showQuickLog) {
              const suggested = suggestVendor();
              setSelectedVendor(suggested);
              setTripDate(new Date().toISOString().split('T')[0]);
              
              // Calculate total from item prices
              const purchasedList = aggregatedIngredients.filter(ing => purchasedItems.has(ing.name));
              const newItemsToLog = purchasedList.filter(ing => !loggedItems.has(ing.name));
              
              const itemsWithPrices = newItemsToLog.filter(item => {
                const priceData = ingredientPrices[item.name];
                // Accept items with price - for recipe items also need packageQuantity
                if (item.hasQuantity) {
                  return priceData?.price > 0 && priceData?.packageQuantity > 0;
                } else {
                  return priceData?.price > 0;
                }
              });
              
              if (itemsWithPrices.length > 0) {
                // Quick Log uses flat package prices (what you paid at store)
                let calculatedTotal = 0;
                itemsWithPrices.forEach(item => {
                  const priceData = ingredientPrices[item.name];
                  calculatedTotal += parseFloat(priceData.price);
                });
                
                setTripTotal(Math.round(calculatedTotal).toString());
              } else {
                setTripTotal('');
              }
            }
          }, [showQuickLog, aggregatedIngredients, purchasedItems, loggedItems, ingredientPrices]);

          // Save price history to localStorage whenever it changes
          useEffect(() => {
            if (Object.keys(priceHistoryData).length > 0) {
              localStorage.setItem('priceHistoryData', JSON.stringify(priceHistoryData));
            }
          }, [priceHistoryData]);

          // Save lastKnownPrices to localStorage
          useEffect(() => {
            if (Object.keys(lastKnownPrices).length > 0) {
              localStorage.setItem('lastKnownPrices', JSON.stringify(lastKnownPrices));
            }
          }, [lastKnownPrices]);

          const toggleRecipe = (recipeId) => {
            setSelectedRecipes(prev => {
              const newState = { ...prev };
              if (newState[recipeId]) {
                delete newState[recipeId];
              } else {
                newState[recipeId] = 1;
              }
              return newState;
            });
          };

          const updateBatches = (recipeId, batches) => {
            const numBatches = Math.max(0.5, parseFloat(batches) || 0);
            setSelectedRecipes(prev => ({
              ...prev,
              [recipeId]: numBatches
            }));
          };

          const toggleFavorite = (recipeId) => {
            setRecipes(prev => prev.map(r => 
              r.id === recipeId ? { ...r, isFavorite: !r.isFavorite } : r
            ));
          };

          const deleteRecipe = (recipeId) => {
            if (confirm('Are you sure you want to delete this recipe?')) {
              setRecipes(prev => prev.filter(r => r.id !== recipeId));
              setSelectedRecipes(prev => {
                const newState = { ...prev };
                delete newState[recipeId];
                return newState;
              });
            }
          };

          const startEditRecipe = (recipe) => {
            setEditingRecipe(recipe);
            setShowRecipeForm(true);
          };

          const startNewRecipe = () => {
            setEditingRecipe(null);
            setShowRecipeForm(true);
          };

          const duplicateRecipe = (recipe) => {
            const duplicate = {
              ...recipe,
              id: undefined, // Will be assigned when saved
              name: `${recipe.name} (Copy)`,
              isFavorite: false // Don't copy favorite status
            };
            setEditingRecipe(duplicate);
            setShowRecipeForm(true);
          };

          const togglePurchased = (ingredientName) => {
            setPurchasedItems(prev => {
              const newSet = new Set(prev);
              if (newSet.has(ingredientName)) {
                newSet.delete(ingredientName);
              } else {
                newSet.add(ingredientName);
                
                // Remove from Quick Add items when checked off
                setQuickAddItems(prevQuickAdd => 
                  prevQuickAdd.filter(item => item.name !== ingredientName)
                );
                
                // Save price when checking off item (if price data is complete)
                const priceData = ingredientPrices[ingredientName];
                if (priceData?.price && priceData.price > 0 && priceData?.packageQuantity && priceData.packageQuantity > 0) {
                  const today = new Date().toISOString().split('T')[0];
                  
                  setLastKnownPrices(prev => ({
                    ...prev,
                    [ingredientName]: {
                      price: priceData.price,
                      packageQuantity: priceData.packageQuantity,
                      packageUnit: priceData.packageUnit || '',
                      date: today
                    }
                  }));
                  
                  // Also log to price history
                  setPriceHistoryData(prev => {
                    const existing = prev[ingredientName] || [];
                    // Only add if price is different from last entry or it's been more than a day
                    const lastEntry = existing[existing.length - 1];
                    if (!lastEntry || lastEntry.price !== priceData.price || lastEntry.date !== today) {
                      return {
                        ...prev,
                        [ingredientName]: [...existing, {
                          date: today,
                          price: priceData.price,
                          packageQuantity: priceData.packageQuantity,
                          packageUnit: priceData.packageUnit || ''
                        }]
                      };
                    }
                    return prev;
                  });
                }
              }
              return newSet;
            });
          };

          const clearPurchasedItems = () => {
            setPurchasedItems(new Set());
            setLoggedItems(new Set()); // Also clear logged items tracker
          };

          // Auto-suggest vendor based on purchased items' locations
          const suggestVendor = () => {
            const purchasedList = aggregatedIngredients.filter(ing => purchasedItems.has(ing.name));
            if (purchasedList.length === 0) return vendors[0] || '';

            // Count which vendor/location appears most in the checked items
            const vendorScores = {};
            
            purchasedList.forEach(item => {
              if (item.location && item.location.trim()) {
                vendorScores[item.location] = (vendorScores[item.location] || 0) + 1;
              }
            });

            // If we found locations on the purchased items, use the most common one
            if (Object.keys(vendorScores).length > 0) {
              const topVendor = Object.keys(vendorScores).reduce((a, b) => 
                vendorScores[a] > vendorScores[b] ? a : b
              );
              return topVendor;
            }

            // Fallback: if no locations set, return first vendor or empty
            return vendors[0] || '';
          };

          // Save prices from Update Prices view to history
          const savePricesFromUpdateView = () => {
            const today = new Date().toISOString().split('T')[0];
            const updates = [];
            
            // Collect all valid price entries
            Object.entries(ingredientPrices).forEach(([ingredientName, priceData]) => {
              if (priceData?.price && priceData.price > 0 && priceData?.packageQuantity && priceData.packageQuantity > 0) {
                const existing = priceHistoryData[ingredientName] || [];
                const lastEntry = existing[existing.length - 1];
                
                // Check if this is new/different
                const isNew = !lastEntry || 
                             lastEntry.date !== today ||
                             parseFloat(lastEntry.price) !== parseFloat(priceData.price) ||
                             parseFloat(lastEntry.packageQuantity || 0) !== parseFloat(priceData.packageQuantity) ||
                             (lastEntry.packageUnit || '') !== (priceData.packageUnit || '');
                
                updates.push({ ingredientName, priceData, isNew });
              }
            });
            
            if (updates.length === 0) {
              alert('â„¹ï¸ No prices to save. Please enter price and quantity for at least one ingredient.');
              return;
            }
            
            const newPriceCount = updates.filter(u => u.isNew).length;
            
            // Save all to lastKnownPrices
            updates.forEach(({ ingredientName, priceData }) => {
              setLastKnownPrices(prev => ({
                ...prev,
                [ingredientName]: {
                  price: priceData.price,
                  packageQuantity: priceData.packageQuantity,
                  packageUnit: priceData.packageUnit || '',
                  date: today
                }
              }));
            });
            
            // Save new prices to history
            updates.filter(u => u.isNew).forEach(({ ingredientName, priceData }) => {
              setPriceHistoryData(prev => ({
                ...prev,
                [ingredientName]: [...(prev[ingredientName] || []), {
                  date: today,
                  price: priceData.price,
                  packageQuantity: priceData.packageQuantity,
                  packageUnit: priceData.packageUnit || ''
                }]
              }));
            });
            
            // Show message
            if (newPriceCount > 0) {
              alert(`âœ“ Saved ${newPriceCount} price${newPriceCount !== 1 ? 's' : ''} to history!`);
            } else {
              alert('â„¹ï¸ No new prices to save (all prices already up to date for today).');
            }
          };

          // Save shopping trip (Quick Log mode)
          const saveQuickTrip = (total, vendor, date) => {
            // Only include purchased items that haven't been logged yet
            const purchasedList = aggregatedIngredients.filter(ing => 
              purchasedItems.has(ing.name) && !loggedItems.has(ing.name)
            );
            
            if (purchasedList.length === 0) {
              alert('âš ï¸ All checked items have already been logged to a previous trip.');
              return null;
            }
            
            const newTrip = {
              id: `trip-${Date.now()}`,
              date: date || new Date().toISOString().split('T')[0],
              vendor: vendor,
              mode: 'quick',
              total: parseFloat(total) || 0,
              itemCount: purchasedList.length,
              items: purchasedList.map(ing => ({
                name: ing.name,
                quantity: ing.total,
                unit: ing.unit,
                location: ing.location
              }))
            };

            setShoppingTrips(prev => [newTrip, ...prev]);
            
            // Mark these items as logged
            setLoggedItems(prev => {
              const newSet = new Set(prev);
              purchasedList.forEach(ing => newSet.add(ing.name));
              return newSet;
            });
            
            return newTrip;
          };

          // Edit shopping trip
          const updateTrip = (tripId, updates) => {
            setShoppingTrips(prev => prev.map(trip => 
              trip.id === tripId ? { ...trip, ...updates } : trip
            ));
          };

          // Delete shopping trip
          const deleteTrip = (tripId) => {
            const trip = shoppingTrips.find(t => t.id === tripId);
            if (!trip) return;
            
            if (!confirm(`Delete trip from ${trip.vendor} on ${new Date(trip.date).toLocaleDateString()}?`)) {
              return;
            }
            
            // Remove trip
            setShoppingTrips(prev => prev.filter(t => t.id !== tripId));
            
            // Clear logged status for items in this trip so they can be re-logged
            if (trip.items && trip.items.length > 0) {
              setLoggedItems(prev => {
                const newSet = new Set(prev);
                trip.items.forEach(item => newSet.delete(item.name));
                return newSet;
              });
            }
          };

          // Delete a price history entry
          const deletePriceHistoryEntry = (ingredientName, entryIndex) => {
            if (!confirm(`Delete this price entry for ${ingredientName}?`)) {
              return;
            }
            
            setPriceHistoryData(prev => {
              const history = prev[ingredientName] || [];
              const updated = history.filter((_, index) => index !== entryIndex);
              
              if (updated.length === 0) {
                // Remove ingredient entirely if no history left
                const { [ingredientName]: removed, ...rest } = prev;
                return rest;
              }
              
              return {
                ...prev,
                [ingredientName]: updated
              };
            });
          };

          // Update a price history entry
          const updatePriceHistoryEntry = (ingredientName, entryIndex, updatedEntry) => {
            setPriceHistoryData(prev => {
              const history = prev[ingredientName] || [];
              const updated = [...history];
              updated[entryIndex] = updatedEntry;
              
              return {
                ...prev,
                [ingredientName]: updated
              };
            });
            
            setEditingPriceEntry(null);
          };

          const addPriceHistoryEntry = (ingredientName, newEntry) => {
            setPriceHistoryData(prev => {
              const history = prev[ingredientName] || [];
              const updated = [...history, newEntry];
              return { ...prev, [ingredientName]: updated };
            });
            setAddingPriceEntry(null);
          };

          // Export trips to CSV
          const exportTripsToCSV = () => {
            const headers = ['Date', 'Vendor', 'Total (TWD)', 'Items', 'Item Count'];
            const rows = shoppingTrips.map(trip => [
              trip.date,
              trip.vendor || '',
              trip.total || '',
              trip.items?.map(i => i.name).join('; ') || '',
              trip.itemCount || trip.items?.length || 0
            ]);

            const csv = [headers, ...rows].map(row => row.map(cell => 
              `"${String(cell).replace(/"/g, '""')}"`
            ).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shopping-trips-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
          };

          const handleQuickAdd = () => {
            const input = quickAddInput.trim().toLowerCase();
            if (!input) return;
            
            // Parse input like "garlic paste 300g" or "salt 1000 g" into name, quantity, and unit
            // Match patterns:
            // - "garlic paste 300g" (space before number, no space before unit)
            // - "garlic paste 300 g" (space before number, space before unit)
            // - "salt300g" or "salt 300g" (with or without space)
            const quantityMatch = input.match(/^(.+?)\s*(\d+(?:\.\d+)?)\s*([a-zA-Z]+)\s*$/);
            
            let itemName, quantity, unit;
            if (quantityMatch && quantityMatch[3]) {
              // Has quantity and unit (unit is required for this pattern)
              itemName = quantityMatch[1].trim();
              quantity = parseFloat(quantityMatch[2]);
              unit = quantityMatch[3];
              
              // If itemName is empty (e.g., "300g" with no name), treat whole thing as name
              if (!itemName) {
                itemName = input;
                quantity = null;
                unit = '';
              }
            } else {
              // Just name, no quantity/unit pattern found
              itemName = input;
              quantity = null;
              unit = '';
            }
            
            // Check if already exists in quick add items
            const exists = quickAddItems.some(item => item.name === itemName);
            if (exists) {
              alert(`"${itemName}" is already in your quick add list`);
              setQuickAddInput('');
              return;
            }
            
            // Add to quick add items with parsed quantity and unit
            // Try to find existing location for this ingredient from recipes
            let suggestedLocation = '';
            for (const recipe of recipes) {
              const foundIng = recipe.ingredients.find(ing => ing.name === itemName);
              if (foundIng && foundIng.location) {
                suggestedLocation = foundIng.location;
                break;
              }
            }
            
            setQuickAddItems(prev => [...prev, {
              name: itemName,
              isQuickAdd: true,
              location: suggestedLocation,
              quantity: quantity,
              unit: unit
            }]);
            
            // Add to planToBuyItems so it appears in shopping list
            setPlanToBuyItems(prev => {
              const newSet = new Set(prev);
              newSet.add(itemName);
              return newSet;
            });

            setQuickAddInput('');
          };

          const removeQuickAddItem = (itemName) => {
            setQuickAddItems(prev => prev.filter(item => item.name !== itemName));
            // Also remove from purchased if it was checked
            setPurchasedItems(prev => {
              const newSet = new Set(prev);
              newSet.delete(itemName);
              return newSet;
            });
          };

          const exportRecipes = () => {
            const exportData = {
              version: "1.2",
              exportDate: new Date().toISOString(),
              recipes: recipes,
              lastKnownPrices: lastKnownPrices,
              priceHistoryData: priceHistoryData,
              vendors: vendors,
              shoppingTrips: shoppingTrips,
              packageUnits: packageUnits
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `recipes-backup-${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`âœ“ Exported ${recipes.length} recipe${recipes.length !== 1 ? 's' : ''} successfully!`);
          };

          const importRecipes = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
              const file = e.target.files[0];
              if (!file) return;
              
              const reader = new FileReader();
              reader.onload = (event) => {
                try {
                  const importData = JSON.parse(event.target.result);
                  
                  // Validate data structure
                  if (!importData.recipes || !Array.isArray(importData.recipes)) {
                    alert('âŒ Invalid file format. Please select a valid recipe backup file.');
                    return;
                  }
                  
                  const importedRecipes = importData.recipes;
                  const importedPrices = importData.lastKnownPrices || {};
                  const importedPriceHistory = importData.priceHistoryData || {};
                  const importedVendors = importData.vendors || [];
                  const importedTrips = importData.shoppingTrips || [];
                  const importedUnits = importData.packageUnits || [];
                  
                  if (importedRecipes.length === 0) {
                    alert('âŒ The file contains no recipes.');
                    return;
                  }
                  
                  // Show import options
                  const existingCount = recipes.length;
                  const importCount = importedRecipes.length;
                  const priceCount = Object.keys(importedPrices).length;
                  const priceHistoryCount = Object.keys(importedPriceHistory).length;
                  const vendorCount = importedVendors.length;
                  const tripCount = importedTrips.length;
                  
                  let message = `Found ${importCount} recipe${importCount !== 1 ? 's' : ''}`;
                  const extraData = [];
                  if (priceCount > 0) extraData.push(`${priceCount} price${priceCount !== 1 ? 's' : ''}`);
                  if (priceHistoryCount > 0) extraData.push(`${priceHistoryCount} price histor${priceHistoryCount !== 1 ? 'ies' : 'y'}`);
                  if (vendorCount > 0) extraData.push(`${vendorCount} vendor${vendorCount !== 1 ? 's' : ''}`);
                  if (tripCount > 0) extraData.push(`${tripCount} trip${tripCount !== 1 ? 's' : ''}`);
                  if (extraData.length > 0) {
                    message += `, ${extraData.join(', ')}`;
                  }
                  message += ` in the file.\n`;
                  
                  if (existingCount > 0) {
                    message += `You currently have ${existingCount} recipe${existingCount !== 1 ? 's' : ''}.\n\n`;
                    message += `Choose import mode:\n`;
                    message += `â€¢ OK = Merge (keep existing + add new)\n`;
                    message += `â€¢ Cancel = Go back`;
                    
                    if (confirm(message)) {
                      // Merge mode - update existing recipes by name, add new ones
                      let updatedCount = 0;
                      let addedCount = 0;
                      
                      setRecipes(prev => {
                        const updated = [...prev];
                        const maxId = updated.length > 0 ? Math.max(...updated.map(r => r.id)) : 0;
                        let nextId = maxId + 1;
                        
                        importedRecipes.forEach(importedRecipe => {
                          // Force lowercase on ingredient names during import
                          const normalizedRecipe = {
                            ...importedRecipe,
                            ingredients: importedRecipe.ingredients.map(ing => ({
                              ...ing,
                              name: ing.name.toLowerCase()
                            }))
                          };
                          
                          // Check if recipe with same name already exists
                          const existingIndex = updated.findIndex(r => 
                            r.name.toLowerCase() === normalizedRecipe.name.toLowerCase()
                          );
                          
                          if (existingIndex !== -1) {
                            // Update existing recipe, keep its ID
                            updated[existingIndex] = {
                              ...normalizedRecipe,
                              id: updated[existingIndex].id
                            };
                            updatedCount++;
                          } else {
                            // Add new recipe with new ID
                            updated.push({
                              ...normalizedRecipe,
                              id: nextId++
                            });
                            addedCount++;
                          }
                        });
                        
                        return updated;
                      });
                      
                      // Merge price data
                      if (priceCount > 0) {
                        setLastKnownPrices(prev => ({...prev, ...importedPrices}));
                      }
                      if (priceHistoryCount > 0) {
                        setPriceHistoryData(prev => ({...prev, ...importedPriceHistory}));
                      }
                      
                      // Merge vendors (avoid duplicates)
                      if (vendorCount > 0) {
                        setVendors(prev => {
                          const combined = [...prev];
                          importedVendors.forEach(vendor => {
                            if (!combined.includes(vendor)) {
                              combined.push(vendor);
                            }
                          });
                          return combined;
                        });
                      }
                      
                      // Merge trips (append new ones)
                      if (tripCount > 0) {
                        setShoppingTrips(prev => [...prev, ...importedTrips]);
                      }
                      
                      // Merge package units (avoid duplicates)
                      if (importedUnits.length > 0) {
                        setPackageUnits(prev => {
                          const combined = [...prev];
                          importedUnits.forEach(unit => {
                            if (!combined.includes(unit)) {
                              combined.push(unit);
                            }
                          });
                          return combined;
                        });
                      }
                      
                      let successMsg = 'âœ“ Successfully merged: ';
                      const successParts = [];
                      if (updatedCount > 0) successParts.push(`${updatedCount} updated`);
                      if (addedCount > 0) successParts.push(`${addedCount} added`);
                      if (priceCount > 0) successParts.push(`${priceCount} price${priceCount !== 1 ? 's' : ''}`);
                      if (priceHistoryCount > 0) successParts.push(`${priceHistoryCount} price histor${priceHistoryCount !== 1 ? 'ies' : 'y'}`);
                      if (vendorCount > 0) successParts.push(`${vendorCount} vendor${vendorCount !== 1 ? 's' : ''}`);
                      if (tripCount > 0) successParts.push(`${tripCount} trip${tripCount !== 1 ? 's' : ''}`);
                      successMsg += successParts.join(', ');
                      alert(successMsg + '!');
                    }
                  } else {
                    // No existing recipes, just import with normalized ingredient names
                    const recipesWithIds = importedRecipes.map((recipe, index) => ({
                      ...recipe,
                      id: index + 1,
                      ingredients: recipe.ingredients.map(ing => ({
                        ...ing,
                        name: ing.name.toLowerCase()
                      }))
                    }));
                    setRecipes(recipesWithIds);
                    
                    // Import all data
                    if (priceCount > 0) {
                      setLastKnownPrices(importedPrices);
                    }
                    if (priceHistoryCount > 0) {
                      setPriceHistoryData(importedPriceHistory);
                    }
                    if (vendorCount > 0) {
                      setVendors(importedVendors);
                    }
                    if (tripCount > 0) {
                      setShoppingTrips(importedTrips);
                    }
                    if (importedUnits.length > 0) {
                      setPackageUnits(importedUnits);
                    }
                    
                    let successMsg = `âœ“ Successfully imported ${importCount} recipe${importCount !== 1 ? 's' : ''}`;
                    const successExtra = [];
                    if (priceCount > 0) successExtra.push(`${priceCount} price${priceCount !== 1 ? 's' : ''}`);
                    if (priceHistoryCount > 0) successExtra.push(`${priceHistoryCount} price histor${priceHistoryCount !== 1 ? 'ies' : 'y'}`);
                    if (vendorCount > 0) successExtra.push(`${vendorCount} vendor${vendorCount !== 1 ? 's' : ''}`);
                    if (tripCount > 0) successExtra.push(`${tripCount} trip${tripCount !== 1 ? 's' : ''}`);
                    if (successExtra.length > 0) {
                      successMsg += `, ${successExtra.join(', ')}`;
                    }
                    alert(successMsg + '!');
                  }
                  
                } catch (error) {
                  alert('âŒ Error reading file. Please make sure it\'s a valid JSON file.');
                  console.error('Import error:', error);
                }
              };
              
              reader.readAsText(file);
            };
            
            input.click();
          };

          const replaceAllRecipes = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
              const file = e.target.files[0];
              if (!file) return;
              
              const reader = new FileReader();
              reader.onload = (event) => {
                try {
                  const importData = JSON.parse(event.target.result);
                  
                  if (!importData.recipes || !Array.isArray(importData.recipes)) {
                    alert('âŒ Invalid file format. Please select a valid recipe backup file.');
                    return;
                  }
                  
                  const importedRecipes = importData.recipes;
                  const importedPrices = importData.lastKnownPrices || {};
                  
                  if (importedRecipes.length === 0) {
                    alert('âŒ The file contains no recipes.');
                    return;
                  }
                  
                  const priceCount = Object.keys(importedPrices).length;
                  let message = `âš ï¸ WARNING: This will replace all ${recipes.length} existing recipe${recipes.length !== 1 ? 's' : ''} with ${importedRecipes.length} recipe${importedRecipes.length !== 1 ? 's' : ''} from the file`;
                  if (priceCount > 0) {
                    message += ` and ${priceCount} price${priceCount !== 1 ? 's' : ''}`;
                  }
                  message += '.\n\nThis cannot be undone!\n\nContinue?';
                  
                  if (confirm(message)) {
                    const recipesWithIds = importedRecipes.map((recipe, index) => ({
                      ...recipe,
                      id: index + 1,
                      ingredients: recipe.ingredients.map(ing => ({
                        ...ing,
                        name: ing.name.toLowerCase()
                      }))
                    }));
                    setRecipes(recipesWithIds);
                    setSelectedRecipes({});
                    
                    // Replace price history
                    if (priceCount > 0) {
                      setLastKnownPrices(importedPrices);
                    }
                    
                    let successMsg = `âœ“ Successfully replaced with ${importedRecipes.length} recipe${importedRecipes.length !== 1 ? 's' : ''}`;
                    if (priceCount > 0) {
                      successMsg += ` and ${priceCount} price${priceCount !== 1 ? 's' : ''}`;
                    }
                    alert(successMsg + '!');
                  }
                  
                } catch (error) {
                  alert('âŒ Error reading file. Please make sure it\'s a valid JSON file.');
                  console.error('Import error:', error);
                }
              };
              
              reader.readAsText(file);
            };
            
            input.click();
          };

          const aggregatedIngredients = useMemo(() => {
            const ingredientMap = new Map();

            // Add items from selected recipes
            Object.entries(selectedRecipes).forEach(([recipeId, batches]) => {
              if (batches <= 0) return;
              
              const recipe = recipes.find(r => r.id === parseInt(recipeId));
              if (!recipe) return;

              recipe.ingredients.forEach(ingredient => {
                const key = ingredient.name;
                
                if (!ingredientMap.has(key)) {
                  ingredientMap.set(key, {
                    name: ingredient.name,
                    total: 0,
                    unit: ingredient.unit,
                    hasQuantity: ingredient.quantity !== null,
                    price: ingredient.price,
                    totalCost: 0,
                    location: ingredient.location || '',
                    isQuickAdd: false
                  });
                } else {
                  // If ingredient already exists, update location if current one has a location set
                  const item = ingredientMap.get(key);
                  if (ingredient.location && ingredient.location.trim() && !item.location) {
                    item.location = ingredient.location;
                  }
                }

                const item = ingredientMap.get(key);
                if (ingredient.quantity !== null) {
                  item.total += ingredient.quantity * batches;
                  if (ingredient.price !== null) {
                    item.totalCost += ingredient.price * ingredient.quantity * batches;
                  }
                }
              });
            });

            // Add quick add items (they won't have quantities from recipes)
            quickAddItems.forEach(quickItem => {
              const key = quickItem.name;
              if (!ingredientMap.has(key)) {
                ingredientMap.set(key, {
                  name: quickItem.name,
                  total: quickItem.quantity || 0,
                  unit: quickItem.unit || '',
                  hasQuantity: quickItem.quantity !== null && quickItem.quantity !== undefined,
                  price: null,
                  totalCost: 0,
                  location: quickItem.location || '',
                  isQuickAdd: true
                });
              } else {
                // If already exists from recipes, add the quick add quantity
                const item = ingredientMap.get(key);
                if (quickItem.quantity) {
                  item.total += quickItem.quantity;
                }
              }
            });

            return Array.from(ingredientMap.values()).sort((a, b) => 
              a.name.localeCompare(b.name)
            );
          }, [selectedRecipes, recipes, quickAddItems]);

          // Auto-load prices when shopping list changes
          useEffect(() => {
            if (aggregatedIngredients.length === 0) {
              return; // No ingredients, nothing to load
            }

            const aggregatedNames = aggregatedIngredients.map(ing => ing.name);
            const newPrices = {};
            
            aggregatedNames.forEach(name => {
              if (lastKnownPrices[name]) {
                newPrices[name] = {
                  price: lastKnownPrices[name].price,
                  packageQuantity: lastKnownPrices[name].packageQuantity,
                  packageUnit: lastKnownPrices[name].packageUnit
                };
              }
            });
            
            if (Object.keys(newPrices).length > 0) {
              setIngredientPrices(newPrices);
            }
          }, [aggregatedIngredients, lastKnownPrices]);

          // Get all unique ingredients for Price Management view
          const allIngredients = useMemo(() => {
            const ingredientMap = new Map();
            
            recipes.forEach(recipe => {
              recipe.ingredients.forEach(ingredient => {
                if (!ingredientMap.has(ingredient.name)) {
                  ingredientMap.set(ingredient.name, {
                    name: ingredient.name,
                    unit: ingredient.unit,
                    location: ingredient.location || '',
                    quickAddQuantity: null,
                    quickAddUnit: ''
                  });
                }
              });
            });
            
            // Also add quick add items with their parsed quantity/unit
            quickAddItems.forEach(item => {
              if (!ingredientMap.has(item.name)) {
                ingredientMap.set(item.name, {
                  name: item.name,
                  unit: item.unit || '',
                  location: item.location || '',
                  quickAddQuantity: item.quantity || null,
                  quickAddUnit: item.unit || ''
                });
              } else {
                // If already exists from recipes, store quick add quantity separately
                const existing = ingredientMap.get(item.name);
                existing.quickAddQuantity = item.quantity || null;
                existing.quickAddUnit = item.unit || '';
              }
            });
            
            return Array.from(ingredientMap.values()).sort((a, b) => a.name.localeCompare(b.name));
          }, [recipes, quickAddItems]);

          // Filtered ingredients for Price Management view
          const filteredPriceIngredients = useMemo(() => {
            if (!priceSearchQuery.trim()) {
              return allIngredients;
            }
            
            const query = priceSearchQuery.toLowerCase();
            const filtered = allIngredients.filter(ing => 
              ing.name.toLowerCase().includes(query)
            );
            
            // Sort with starts-with matches first, then contains, then alphabetical
            return filtered.sort((a, b) => {
              const aLower = a.name.toLowerCase();
              const bLower = b.name.toLowerCase();
              
              const aStarts = aLower.startsWith(query);
              const bStarts = bLower.startsWith(query);
              
              if (aStarts && !bStarts) return -1;
              if (!aStarts && bStarts) return 1;
              
              return aLower.localeCompare(bLower);
            });
          }, [allIngredients, priceSearchQuery]);

          const remainingItems = aggregatedIngredients.filter(ing => !purchasedItems.has(ing.name));
          const purchasedItemsList = aggregatedIngredients.filter(ing => purchasedItems.has(ing.name));

          // Track previous aggregatedIngredients to detect NEW items
          const prevIngredientsRef = useRef(new Set());

          // Initialize planToBuyItems when aggregatedIngredients change
          useEffect(() => {
            const currentNames = new Set(aggregatedIngredients.map(ing => ing.name));
            const prevNames = prevIngredientsRef.current;
            
            setPlanToBuyItems(prev => {
              const newSet = new Set(prev);
              
              aggregatedIngredients.forEach(ing => {
                // Only auto-add if:
                // 1. It's NOT a QuickAdd item (recipe items auto-add)
                // 2. It's NOT already in planToBuyItems
                // 3. It's NOT purchased
                // 4. It's a NEW item (wasn't in previous aggregatedIngredients)
                if (!ing.isQuickAdd && 
                    !newSet.has(ing.name) && 
                    !purchasedItems.has(ing.name) &&
                    !prevNames.has(ing.name)) {
                  newSet.add(ing.name);
                }
              });
              
              // Remove items that no longer exist in aggregated list (recipes deselected)
              Array.from(newSet).forEach(name => {
                if (!currentNames.has(name)) {
                  newSet.delete(name);
                }
              });
              
              return newSet;
            });
            
            // Update the ref for next comparison
            prevIngredientsRef.current = currentNames;
          }, [aggregatedIngredients]);

          // Group remaining items by location
          const groupedByLocation = useMemo(() => {
            const groups = {};
            
            remainingItems
              .filter(ingredient => planToBuyItems.has(ingredient.name))
              .forEach(ingredient => {
              const location = ingredient.location && ingredient.location.trim() ? ingredient.location.trim() : 'Unspecified';
              if (!groups[location]) {
                groups[location] = [];
              }
              groups[location].push(ingredient);
            });
            
            // Sort each group alphabetically
            Object.keys(groups).forEach(location => {
              groups[location].sort((a, b) => a.name.localeCompare(b.name));
            });
            
            // Return sorted location names and their items
            const sortedLocations = Object.keys(groups).sort((a, b) => {
              // "Unspecified" always goes last
              if (a === 'Unspecified') return 1;
              if (b === 'Unspecified') return -1;
              return a.localeCompare(b);
            });
            
            return sortedLocations.map(location => ({
              location,
              items: groups[location]
            }));
          }, [remainingItems, planToBuyItems]);

          // Auto-collapse all vendor sections when shopping list changes
          // EXCEPT "Unspecified" if it contains Quick Add items (keep it expanded)
          useEffect(() => {
            const newCollapsed = {};
            groupedByLocation.forEach(({ location, items }) => {
              // Check if this location has any Quick Add items
              const hasQuickAdd = items.some(item => item.isQuickAdd);
              // Collapse all except Unspecified with Quick Add items
              newCollapsed[location] = location === 'Unspecified' && hasQuickAdd ? false : true;
            });
            setCollapsedSections(newCollapsed);
          }, [groupedByLocation.map(g => g.location).join(',')]);

          const toggleSection = (location) => {
            setCollapsedSections(prev => ({
              ...prev,
              [location]: !prev[location]
            }));
          };

          const togglePlanToBuy = (ingredientName) => {
            setPlanToBuyItems(prev => {
              const newSet = new Set(prev);
              if (newSet.has(ingredientName)) {
                newSet.delete(ingredientName);
                // Also remove from Quick Add items when removing from shopping list
                setQuickAddItems(prevQuickAdd => 
                  prevQuickAdd.filter(item => item.name !== ingredientName)
                );
              } else {
                newSet.add(ingredientName);
              }
              return newSet;
            });
          };

          const selectAllForPurchase = () => {
            const allNames = new Set(remainingItems.map(ing => ing.name));
            setPlanToBuyItems(allNames);
          };

          const deselectAll = () => {
            setPlanToBuyItems(new Set());
          };

          const selectAllRecipes = () => {
            const allSelected = {};
            recipes.forEach(recipe => {
              allSelected[recipe.id] = 1;
            });
            setSelectedRecipes(allSelected);
          };

          const completeShoppingTrip = () => {
            if (!confirm('Complete shopping trip? This will:\nâ€¢ Clear all checked items\nâ€¢ Deselect all recipes\nâ€¢ Clear price inputs\nâ€¢ Keep your Quick Add items')) {
              return;
            }
            setPurchasedItems(new Set());
            setLoggedItems(new Set());
            setSelectedRecipes({});
            setIngredientPrices({});
            setPlanToBuyItems(new Set());
          };

          const exportShoppingList = () => {
            const itemsToBuy = aggregatedIngredients.filter(ing => planToBuyItems.has(ing.name));
            
            if (itemsToBuy.length === 0) {
              alert('No items in shopping list to export');
              return;
            }

            // Group by location
            const byLocation = {};
            itemsToBuy.forEach(ing => {
              const location = ing.location || 'Unspecified';
              if (!byLocation[location]) byLocation[location] = [];
              byLocation[location].push(ing);
            });

            // Format as text
            let text = 'ðŸ›’ Shopping List\n';
            text += `ðŸ“… ${new Date().toLocaleDateString()}\n\n`;
            
            Object.entries(byLocation).forEach(([location, items]) => {
              text += `ðŸ“ ${location}\n`;
              items.forEach(ing => {
                const checkbox = purchasedItems.has(ing.name) ? 'âœ…' : 'â˜';
                const amount = ing.hasQuantity ? ` (${formatAmount(ing.total)} ${ing.unit})` : '';
                text += `${checkbox} ${ing.name}${amount}\n`;
              });
              text += '\n';
            });

            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
              alert('âœ“ Shopping list copied to clipboard!\nYou can now paste it into LINE, Notes, or any messaging app.');
            }).catch(() => {
              // Fallback: show in alert for manual copy
              alert('Shopping list:\n\n' + text);
            });
          };

          const hasSelections = Object.keys(selectedRecipes).length > 0 || quickAddItems.length > 0;

          // Unit conversion helper function
          const convertToBaseUnit = (qty, unit) => {
            const lowerUnit = unit?.toLowerCase() || '';
            // Weight conversions to grams
            if (lowerUnit === 'kg') return qty * 1000;
            if (lowerUnit === 'æ–¤') return qty * 600; // jin
            if (lowerUnit === 'lb') return qty * 453.592;
            if (lowerUnit === 'oz') return qty * 28.3495;
            // Volume conversions to ml
            if (lowerUnit === 'l') return qty * 1000;
            // Default: no conversion
            return qty;
          };

          // Calculate total estimated cost from session prices (package-based)
          const totalCost = useMemo(() => {
            return aggregatedIngredients.reduce((sum, ing) => {
              const priceData = ingredientPrices[ing.name];
              if (priceData?.price > 0 && priceData?.packageQuantity > 0 && ing.hasQuantity) {
                const recipeQtyBase = convertToBaseUnit(ing.total, ing.unit);
                const packageQtyBase = convertToBaseUnit(priceData.packageQuantity, priceData.packageUnit || ing.unit);
                const packagesNeeded = Math.ceil(recipeQtyBase / packageQtyBase); // Round up to whole packages
                const itemCost = packagesNeeded * priceData.price;
                return sum + itemCost;
              }
              return sum;
            }, 0);
          }, [aggregatedIngredients, ingredientPrices]);

          const hasPrices = Object.keys(ingredientPrices).some(key => {
            const priceData = ingredientPrices[key];
            return priceData?.price > 0 && priceData?.packageQuantity > 0;
          });

          // Calculate estimated total based on last known prices (package-based)
          const estimatedTotal = useMemo(() => {
            let total = 0;
            let hasEstimates = false;
            
            aggregatedIngredients.forEach(ing => {
              const lastPrice = lastKnownPrices[ing.name];
              if (lastPrice?.price && ing.hasQuantity) {
                const packageQty = lastPrice.packageQuantity || 1;
                const packageUnit = lastPrice.packageUnit || ing.unit;
                
                const recipeQtyBase = convertToBaseUnit(ing.total, ing.unit);
                const packageQtyBase = convertToBaseUnit(packageQty, packageUnit);
                const packagesNeeded = Math.ceil(recipeQtyBase / packageQtyBase); // Round up to whole packages
                const itemCost = packagesNeeded * lastPrice.price;
                total += itemCost;
                hasEstimates = true;
              }
            });
            
            return hasEstimates ? total : null;
          }, [aggregatedIngredients, lastKnownPrices]);

          // Calculate planned purchase total cost with detailed breakdown (package-based)
          const plannedPurchaseCost = useMemo(() => {
            // Include both remaining items AND purchased items that were planned
            const allPlannedItems = aggregatedIngredients.filter(ing => planToBuyItems.has(ing.name));
            
            let totalCost = 0;
            let itemsWithPrices = 0;
            let itemsWithoutPrices = [];
            const locationTotals = {};
            
            allPlannedItems.forEach(ing => {
              const priceData = ingredientPrices[ing.name];
              
              if (priceData?.price > 0 && priceData?.packageQuantity > 0 && ing.hasQuantity) {
                const recipeQtyBase = convertToBaseUnit(ing.total, ing.unit);
                const packageQtyBase = convertToBaseUnit(priceData.packageQuantity, priceData.packageUnit || ing.unit);
                const packagesNeeded = Math.ceil(recipeQtyBase / packageQtyBase); // Round up to whole packages
                const itemCost = packagesNeeded * priceData.price;
                totalCost += itemCost;
                itemsWithPrices++;
                
                // Track by location
                const location = ing.location && ing.location.trim() ? ing.location.trim() : 'Unspecified';
                if (!locationTotals[location]) {
                  locationTotals[location] = { cost: 0, count: 0 };
                }
                locationTotals[location].cost += itemCost;
                locationTotals[location].count++;
              } else if (ing.hasQuantity && !purchasedItems.has(ing.name)) {
                // Only list unpurchased items without prices
                itemsWithoutPrices.push(ing.name);
              }
            });
            
            return {
              total: totalCost,
              itemCount: allPlannedItems.length,
              itemsWithPrices,
              itemsWithoutPrices,
              locationTotals
            };
          }, [aggregatedIngredients, planToBuyItems, ingredientPrices, purchasedItems]);

          // Filter recipes based on search query and sort favorites first
          const filteredRecipes = useMemo(() => {
            let filtered = recipes;
            if (searchQuery.trim()) {
              const query = searchQuery.toLowerCase();
              filtered = recipes.filter(recipe => 
                recipe.name.toLowerCase().includes(query)
              );
            }
            // Sort: favorites first, then alphabetically
            return filtered.sort((a, b) => {
              if (a.isFavorite && !b.isFavorite) return -1;
              if (!a.isFavorite && b.isFavorite) return 1;
              return a.name.localeCompare(b.name);
            });
          }, [recipes, searchQuery]);

          if (showRecipeForm) {
            return <RecipeForm 
              recipe={editingRecipe}
              recipes={recipes}
              darkMode={darkMode}
              showScrollTop={showScrollTop}
              onSave={(recipe) => {
                if (editingRecipe) {
                  setRecipes(prev => prev.map(r => r.id === recipe.id ? recipe : r));
                } else {
                  const newId = recipes.length > 0 ? Math.max(...recipes.map(r => r.id)) + 1 : 1;
                  setRecipes(prev => [...prev, { ...recipe, id: newId }]);
                }
                setShowRecipeForm(false);
                setEditingRecipe(null);
              }}
              onCancel={() => {
                setShowRecipeForm(false);
                setEditingRecipe(null);
              }}
            />;
          }

          // Ingredient Sources Modal (show on top of Price Management)
          if (showIngredientSources && selectedIngredientForSources) {
            const recipesWithIngredient = recipes.filter(recipe => 
              recipe.ingredients.some(ing => ing.name === selectedIngredientForSources)
            );

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className={`rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-auto ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className={`sticky top-0 p-6 border-b ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="flex items-center justify-between">
                      <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        "{selectedIngredientForSources}" appears in:
                      </h2>
                      <button
                        onClick={() => {
                          setShowIngredientSources(false);
                          setSelectedIngredientForSources(null);
                        }}
                        className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-600'}`}
                      >
                        <X className="w-6 h-6" />
                      </button>
                    </div>
                  </div>
                  
                  <div className="p-6">
                    {recipesWithIngredient.length === 0 ? (
                      <p className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        This ingredient is from Quick Add Items (not in any recipe)
                      </p>
                    ) : (
                      <div className="space-y-3">
                        {recipesWithIngredient.map(recipe => {
                          const ingredientInRecipe = recipe.ingredients.find(ing => ing.name === selectedIngredientForSources);
                          return (
                            <div 
                              key={recipe.id}
                              className={`p-4 rounded-lg border ${darkMode ? 'border-gray-700 bg-gray-700/30' : 'border-gray-200 bg-gray-50'}`}
                            >
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <h3 className={`font-semibold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                    {recipe.name}
                                  </h3>
                                  <p className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Uses: {ingredientInRecipe.quantity} {ingredientInRecipe.unit}
                                    {ingredientInRecipe.location && ` Â· ${ingredientInRecipe.location}`}
                                  </p>
                                </div>
                                <button
                                  onClick={() => {
                                    setEditingRecipe(recipe);
                                    setShowRecipeForm(true);
                                    setShowIngredientSources(false);
                                    setSelectedIngredientForSources(null);
                                    setShowPriceManagement(false);
                                  }}
                                  className={`ml-4 px-3 py-1.5 rounded text-sm ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                                >
                                  Edit Recipe
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          // Price Management View
          if (showPriceManagement) {
            return (
              <div className={`min-h-screen p-4 md:p-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'} relative`}>
                <div className="max-w-6xl mx-auto">
                  {/* Header - sticky on mobile */}
                  <div className={`sticky top-0 z-10 rounded-lg shadow-sm border mb-6 p-4 md:p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <DollarSign className={`w-8 h-8 ${darkMode ? 'text-green-400' : 'text-green-600'}`} />
                        <div>
                          <h1 className={`text-2xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Update Prices</h1>
                          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Update prices for all ingredients in one place ({allIngredients.length} ingredients)
                          </p>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={savePricesFromUpdateView}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium ${
                            darkMode 
                              ? 'bg-green-600 hover:bg-green-700 text-white' 
                              : 'bg-green-600 hover:bg-green-700 text-white'
                          }`}
                          title="Save all entered prices to price history"
                        >
                          <Save className="w-5 h-5" />
                          Save Prices
                        </button>
                        <button
                          onClick={() => {
                            setShowPriceManagement(false);
                            setPriceSearchQuery(''); // Clear search when closing
                          }}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                        >
                          <ArrowLeft className="w-5 h-5" />
                          Back to Shopping List
                        </button>
                      </div>
                    </div>
                    
                    {/* Search Field */}
                    <div className="mt-4">
                      <input
                        type="text"
                        value={priceSearchQuery}
                        onChange={(e) => setPriceSearchQuery(e.target.value)}
                        placeholder="ðŸ” Search ingredients..."
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'}`}
                      />
                      {priceSearchQuery && (
                        <div className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Showing {filteredPriceIngredients.length} of {allIngredients.length} ingredients
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Ingredients List */}
                  <div className={`rounded-lg shadow-sm border p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="space-y-4">
                      {filteredPriceIngredients.map((ingredient, index) => {
                        const lastPrice = lastKnownPrices[ingredient.name];
                        const currentPrice = ingredientPrices[ingredient.name];
                        const hasHistory = priceHistoryData[ingredient.name]?.length > 0;
                        
                        return (
                          <div 
                            key={ingredient.name}
                            className={`border rounded p-2 ${darkMode ? 'border-gray-700 bg-gray-700/30' : 'border-gray-200 bg-gray-50'}`}
                          >
                            {/* Ingredient name and history button */}
                            <div className="flex items-center justify-between mb-1">
                              <button
                                onClick={() => {
                                  setSelectedIngredientForSources(ingredient.name);
                                  setShowIngredientSources(true);
                                }}
                                className={`font-semibold text-sm text-left hover:underline ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}
                                title="See which recipes use this ingredient"
                              >
                                {ingredient.name}
                              </button>
                              {hasHistory && (
                                <button
                                  onClick={() => {
                                    setSelectedIngredient(ingredient.name);
                                    setShowPriceManagement(false);
                                    setShowPriceHistory(true);
                                  }}
                                  className={`text-xs px-1.5 py-0.5 rounded ${darkMode ? 'bg-blue-900 text-blue-300 hover:bg-blue-800' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`}
                                  title="View price history"
                                >
                                  ðŸ“Š
                                </button>
                              )}
                            </div>

                            {/* Last price - compact single line */}
                            {lastPrice && (
                              <div className={`text-xs mb-2 font-normal ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Last: NT${lastPrice.price} / {lastPrice.packageQuantity} {lastPrice.packageUnit} ({lastPrice.date})
                              </div>
                            )}

                            {/* Price entry fields - horizontal on mobile */}
                            <div className="flex gap-1.5">
                              {/* Price */}
                              <div className="flex-1">
                                <input
                                  type="number"
                                  step="0.01"
                                  value={currentPrice?.price || ''}
                                  onChange={(e) => {
                                    const value = e.target.value;
                                    setIngredientPrices(prev => ({
                                      ...prev,
                                      [ingredient.name]: {
                                        ...prev[ingredient.name],
                                        price: value ? parseFloat(value) : null
                                      }
                                    }));
                                  }}
                                  placeholder="NT$"
                                  className={`w-full px-2 py-1.5 text-sm border rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-600 border-gray-500 text-white placeholder-gray-400' : 'border-gray-300'}`}
                                />
                              </div>

                              {/* Package Quantity */}
                              <div className="flex-1">
                                <input
                                  type="number"
                                  step="0.01"
                                  value={currentPrice?.packageQuantity || ingredient.quickAddQuantity || lastPrice?.packageQuantity || ''}
                                  onChange={(e) => {
                                    const value = e.target.value;
                                    setIngredientPrices(prev => ({
                                      ...prev,
                                      [ingredient.name]: {
                                        ...prev[ingredient.name],
                                        packageQuantity: value ? parseFloat(value) : null
                                      }
                                    }));
                                  }}
                                  placeholder="Qty"
                                  className={`w-full px-2 py-1.5 text-sm border rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-600 border-gray-500 text-white placeholder-gray-400' : 'border-gray-300'}`}
                                />
                              </div>

                              {/* Package Unit */}
                              <div className="w-20">
                                <select
                                  value={currentPrice?.packageUnit || ingredient.quickAddUnit || lastPrice?.packageUnit || ''}
                                  onChange={(e) => {
                                    setIngredientPrices(prev => ({
                                      ...prev,
                                      [ingredient.name]: {
                                        ...prev[ingredient.name],
                                        packageUnit: e.target.value
                                      }
                                    }));
                                  }}
                                  className={`w-full px-2 py-1.5 text-sm border rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`}
                                >
                                  <option value="">-</option>
                                  {packageUnits.map(unit => (
                                    <option key={unit} value={unit}>{unit}</option>
                                  ))}
                                </select>
                              </div>
                            </div>

                            {/* Calculated unit price - compact */}
                            {currentPrice?.price > 0 && currentPrice?.packageQuantity > 0 && (
                              <div className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                = NT${(currentPrice.price / currentPrice.packageQuantity).toFixed(2)}/{currentPrice.packageUnit || ingredient.unit}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>

                    {allIngredients.length === 0 && (
                      <div className="text-center py-12">
                        <p className={darkMode ? 'text-gray-400' : 'text-gray-500'}>
                          No ingredients yet. Add some recipes to get started!
                        </p>
                      </div>
                    )}
                  </div>

                  <datalist id="package-units-list">
                    {packageUnits.map(unit => (
                      <option key={unit} value={unit} />
                    ))}
                  </datalist>

                  {/* Scroll to Top Button */}
                  {showScrollTop && (
                    <button
                      onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                      className={`fixed bottom-6 right-6 p-3 rounded-full shadow-lg z-50 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                      title="Scroll to top"
                    >
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                      </svg>
                    </button>
                  )}
                </div>
              </div>
            );
          }

          // Price History View
          if (showPriceHistory) {
            // If viewing a specific ingredient's detail
            if (selectedIngredient) {
              const ingredientHistory = priceHistoryData[selectedIngredient] || [];
              const sortedHistory = [...ingredientHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
              
              // Calculate statistics based on unit prices
              const unitPrices = ingredientHistory.map(h => h.price / h.packageQuantity);
              const currentUnitPrice = unitPrices[unitPrices.length - 1] || 0;
              const avgUnitPrice = unitPrices.length > 0 ? unitPrices.reduce((a, b) => a + b, 0) / unitPrices.length : 0;
              const minUnitPrice = unitPrices.length > 0 ? Math.min(...unitPrices) : 0;
              const maxUnitPrice = unitPrices.length > 0 ? Math.max(...unitPrices) : 0;
              const priceChange = avgUnitPrice > 0 ? ((currentUnitPrice - avgUnitPrice) / avgUnitPrice * 100) : 0;
              
              // Keep raw prices for display context
              const currentEntry = ingredientHistory[ingredientHistory.length - 1];
              
              // Prepare chart data (show last 12 months) - use unit prices
              const chartData = [...ingredientHistory]
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-12)
                .map(entry => ({
                  date: new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                  price: entry.price / entry.packageQuantity, // Use unit price for chart
                  fullDate: entry.date
                }));
              
              return (
                <div className={`min-h-screen p-4 md:p-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                  <div className="max-w-4xl mx-auto">
                    {/* Header */}
                    <div className={`rounded-lg shadow-sm border mb-6 p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                          <BarChart2 className={`w-8 h-8 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
                          <div>
                            <h1 className={`text-2xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{selectedIngredient}</h1>
                            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                              Last updated: {sortedHistory[0]?.date || 'Never'}
                            </p>
                          </div>
                        </div>
                        <button
                          onClick={() => setSelectedIngredient(null)}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                        >
                          <ArrowLeft className="w-5 h-5" />
                          Back
                        </button>
                      </div>
                      
                      {/* Current Price */}
                      <div className={`text-center py-4 ${darkMode ? 'bg-gray-700/50' : 'bg-blue-50'} rounded-lg`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Current Unit Price</p>
                        <p className={`text-4xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                          NT${currentUnitPrice.toFixed(2)}
                        </p>
                        {currentEntry && (
                          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            per {currentEntry.packageUnit} (NT${currentEntry.price} for {currentEntry.packageQuantity} {currentEntry.packageUnit})
                          </p>
                        )}
                      </div>
                    </div>
                    
                    {/* Statistics Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                      <div className={`rounded-lg shadow-sm border p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>6-Month Avg</p>
                        <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>NT${avgUnitPrice.toFixed(2)}</p>
                        <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>per {currentEntry?.packageUnit || 'unit'}</p>
                      </div>
                      <div className={`rounded-lg shadow-sm border p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>vs Average</p>
                        <p className={`text-2xl font-bold ${priceChange > 10 ? 'text-red-500' : priceChange < -10 ? 'text-green-500' : darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          {priceChange > 0 ? 'â†‘' : priceChange < 0 ? 'â†“' : 'â†’'} {Math.abs(priceChange).toFixed(1)}%
                        </p>
                      </div>
                      <div className={`rounded-lg shadow-sm border p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Lowest</p>
                        <p className={`text-2xl font-bold text-green-500`}>NT${minUnitPrice.toFixed(2)}</p>
                        <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>per {currentEntry?.packageUnit || 'unit'}</p>
                      </div>
                      <div className={`rounded-lg shadow-sm border p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Highest</p>
                        <p className={`text-2xl font-bold text-red-500`}>NT${maxUnitPrice.toFixed(2)}</p>
                        <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>per {currentEntry?.packageUnit || 'unit'}</p>
                      </div>
                    </div>
                    
                    {/* Price Chart */}
                    {chartData.length > 0 && (
                      <PriceChart 
                        chartData={chartData} 
                        minPrice={minUnitPrice} 
                        maxPrice={maxUnitPrice} 
                        darkMode={darkMode} 
                      />
                    )}
                    
                    {/* Price History Table */}
                    <div className={`rounded-lg shadow-sm border p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                      <div className="flex items-center justify-between mb-4">
                        <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Price History</h2>
                        <button
                          onClick={() => {
                            const latestEntry = ingredientHistory[ingredientHistory.length - 1];
                            setAddingPriceEntry({
                              ingredientName: selectedIngredient,
                              date: new Date().toISOString().split('T')[0],
                              price: latestEntry?.price || 0,
                              packageQuantity: latestEntry?.packageQuantity || 1,
                              packageUnit: latestEntry?.packageUnit || 'g'
                            });
                          }}
                          className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                        >
                          <Plus className="w-4 h-4" />
                          Add Entry
                        </button>
                      </div>
                      
                      {/* Add Entry Form */}
                      {addingPriceEntry && (
                        <div className={`mb-4 p-4 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-blue-50 border-blue-200'}`}>
                          <h3 className={`text-sm font-medium mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Add New Price Entry</h3>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                              <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Date</label>
                              <input
                                type="date"
                                value={addingPriceEntry.date}
                                onChange={(e) => setAddingPriceEntry({...addingPriceEntry, date: e.target.value})}
                                className={`w-full px-2 py-1 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                              />
                            </div>
                            <div>
                              <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Price (NT$)</label>
                              <input
                                type="number"
                                value={addingPriceEntry.price}
                                onChange={(e) => setAddingPriceEntry({...addingPriceEntry, price: parseFloat(e.target.value) || 0})}
                                className={`w-full px-2 py-1 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                                step="0.01"
                              />
                            </div>
                            <div>
                              <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Quantity</label>
                              <input
                                type="number"
                                value={addingPriceEntry.packageQuantity}
                                onChange={(e) => setAddingPriceEntry({...addingPriceEntry, packageQuantity: parseFloat(e.target.value) || 0})}
                                className={`w-full px-2 py-1 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                              />
                            </div>
                            <div>
                              <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Unit</label>
                              <input
                                type="text"
                                value={addingPriceEntry.packageUnit}
                                onChange={(e) => setAddingPriceEntry({...addingPriceEntry, packageUnit: e.target.value})}
                                className={`w-full px-2 py-1 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                                list="package-units"
                              />
                            </div>
                          </div>
                          <div className="flex gap-2 mt-3">
                            <button
                              onClick={() => addPriceHistoryEntry(selectedIngredient, {
                                date: addingPriceEntry.date,
                                price: addingPriceEntry.price,
                                packageQuantity: addingPriceEntry.packageQuantity,
                                packageUnit: addingPriceEntry.packageUnit
                              })}
                              className={`px-3 py-1 text-sm rounded ${darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`}
                            >
                              Save
                            </button>
                            <button
                              onClick={() => setAddingPriceEntry(null)}
                              className={`px-3 py-1 text-sm rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-700'}`}
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      )}
                      
                      {sortedHistory.length === 0 ? (
                        <p className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>No price history yet</p>
                      ) : (
                        <div className="overflow-x-auto">
                          <table className="w-full">
                            <thead className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                              <tr>
                                <th className={`px-4 py-2 text-left text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Date</th>
                                <th className={`px-4 py-2 text-right text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Price</th>
                                <th className={`px-4 py-2 text-right text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Package</th>
                                <th className={`px-4 py-2 text-right text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Unit Price</th>
                                <th className={`px-4 py-2 text-center text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Actions</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                              {sortedHistory.map((entry, displayIndex) => {
                                // Find the actual index in the unsorted array
                                const actualIndex = ingredientHistory.findIndex(e => 
                                  e.date === entry.date && e.price === entry.price && e.packageQuantity === entry.packageQuantity
                                );
                                
                                const isEditing = editingPriceEntry?.ingredientName === selectedIngredient && editingPriceEntry?.entryIndex === actualIndex;
                                
                                return (
                                  <tr key={actualIndex} className={darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}>
                                    {isEditing ? (
                                      <>
                                        <td className={`px-4 py-2 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-900'}`}>
                                          <input
                                            type="date"
                                            value={editingPriceEntry.date}
                                            onChange={(e) => setEditingPriceEntry({...editingPriceEntry, date: e.target.value})}
                                            className={`w-full px-2 py-1 border rounded ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                          />
                                        </td>
                                        <td className={`px-4 py-2 text-sm`}>
                                          <input
                                            type="number"
                                            value={editingPriceEntry.price}
                                            onChange={(e) => setEditingPriceEntry({...editingPriceEntry, price: parseFloat(e.target.value) || 0})}
                                            className={`w-full px-2 py-1 border rounded text-right ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                            step="0.01"
                                          />
                                        </td>
                                        <td className={`px-4 py-2 text-sm`}>
                                          <div className="flex gap-1">
                                            <input
                                              type="number"
                                              value={editingPriceEntry.packageQuantity}
                                              onChange={(e) => setEditingPriceEntry({...editingPriceEntry, packageQuantity: parseFloat(e.target.value) || 0})}
                                              className={`w-16 px-2 py-1 border rounded text-right ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                            />
                                            <input
                                              type="text"
                                              value={editingPriceEntry.packageUnit}
                                              onChange={(e) => setEditingPriceEntry({...editingPriceEntry, packageUnit: e.target.value})}
                                              className={`w-16 px-2 py-1 border rounded ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                            />
                                          </div>
                                        </td>
                                        <td className={`px-4 py-2 text-sm text-right ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                          {editingPriceEntry.price > 0 && editingPriceEntry.packageQuantity > 0 ? (
                                            <span className={`text-xs ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                              NT${(editingPriceEntry.price / editingPriceEntry.packageQuantity).toFixed(2)}/{editingPriceEntry.packageUnit}
                                            </span>
                                          ) : '-'}
                                        </td>
                                        <td className="px-4 py-2 text-center">
                                          <div className="flex gap-1 justify-center">
                                            <button
                                              onClick={() => updatePriceHistoryEntry(selectedIngredient, actualIndex, editingPriceEntry)}
                                              className="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
                                              title="Save"
                                            >
                                              Save
                                            </button>
                                            <button
                                              onClick={() => setEditingPriceEntry(null)}
                                              className={`px-2 py-1 text-xs rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400'}`}
                                              title="Cancel"
                                            >
                                              Cancel
                                            </button>
                                          </div>
                                        </td>
                                      </>
                                    ) : (
                                      <>
                                        <td className={`px-4 py-2 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-900'}`}>
                                          {new Date(entry.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </td>
                                        <td className={`px-4 py-2 text-sm text-right font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                          NT${entry.price.toFixed(2)}
                                        </td>
                                        <td className={`px-4 py-2 text-sm text-right ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                          {entry.packageQuantity} {entry.packageUnit}
                                        </td>
                                        <td className={`px-4 py-2 text-sm text-right font-semibold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                          NT${(entry.price / entry.packageQuantity).toFixed(2)}/{entry.packageUnit}
                                        </td>
                                        <td className="px-4 py-2 text-center">
                                          <div className="flex gap-1 justify-center">
                                            <button
                                              onClick={() => setEditingPriceEntry({
                                                ingredientName: selectedIngredient,
                                                entryIndex: actualIndex,
                                                date: entry.date,
                                                price: entry.price,
                                                packageQuantity: entry.packageQuantity,
                                                packageUnit: entry.packageUnit
                                              })}
                                              className={`px-2 py-1 text-xs rounded ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                                              title="Edit"
                                            >
                                              Edit
                                            </button>
                                            <button
                                              onClick={() => deletePriceHistoryEntry(selectedIngredient, actualIndex)}
                                              className="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700"
                                              title="Delete"
                                            >
                                              Delete
                                            </button>
                                          </div>
                                        </td>
                                      </>
                                    )}
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Scroll to Top Button */}
                  {showScrollTop && (
                    <button
                      onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                      className={`fixed bottom-6 right-6 p-3 rounded-full shadow-lg z-50 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                      title="Scroll to top"
                    >
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                      </svg>
                    </button>
                  )}
                </div>
              );
            }
            
            // Price History List View
            let ingredientsWithHistory = Object.entries(priceHistoryData)
              .filter(([name, history]) => history.length > 0)
              .map(([name, history]) => {
                const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
                const currentPrice = sortedHistory[0]?.price || 0;
                const prices = history.map(h => h.price);
                const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                const priceChange = avgPrice > 0 ? ((currentPrice - avgPrice) / avgPrice * 100) : 0;
                
                return {
                  name,
                  currentPrice,
                  lastUpdated: sortedHistory[0]?.date || '',
                  priceChange,
                  packageQuantity: sortedHistory[0]?.packageQuantity || 1,
                  packageUnit: sortedHistory[0]?.packageUnit || ''
                };
              });
            
            // Apply search filter
            if (priceHistorySearchQuery.trim()) {
              ingredientsWithHistory = ingredientsWithHistory.filter(item =>
                item.name.toLowerCase().includes(priceHistorySearchQuery.toLowerCase())
              );
            }
            
            // Apply sorting
            if (priceHistorySortBy === 'alphabetical') {
              ingredientsWithHistory.sort((a, b) => a.name.localeCompare(b.name));
            } else {
              // Sort by newest (most recent update first)
              ingredientsWithHistory.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
            }
            
            return (
              <div className={`min-h-screen p-4 md:p-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                <div className="max-w-4xl mx-auto">
                  {/* Header */}
                  <div className={`rounded-lg shadow-sm border mb-6 p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <TrendingUp className={`w-8 h-8 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
                        <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Price History</h1>
                      </div>
                      <button
                        onClick={() => setShowPriceHistory(false)}
                        className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                      >
                        Back to Shopping List
                      </button>
                    </div>
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Track ingredient prices over time and identify trends
                    </p>
                    
                    {/* Search and Sort Controls */}
                    <div className="flex flex-col sm:flex-row gap-3 mt-4">
                      <input
                        type="text"
                        placeholder="Search ingredients..."
                        value={priceHistorySearchQuery}
                        onChange={(e) => setPriceHistorySearchQuery(e.target.value)}
                        className={`flex-1 px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                      />
                      <select
                        value={priceHistorySortBy}
                        onChange={(e) => setPriceHistorySortBy(e.target.value)}
                        className={`px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      >
                        <option value="newest">Sort: Newest First</option>
                        <option value="alphabetical">Sort: A-Z</option>
                      </select>
                    </div>
                  </div>
                  
                  {/* Ingredients List */}
                  <div className={`rounded-lg shadow-sm border p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                      Tracked Ingredients {priceHistorySearchQuery && `(${ingredientsWithHistory.length} found)`}
                    </h2>
                    
                    {ingredientsWithHistory.length === 0 ? (
                      <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        <BarChart2 className="w-16 h-16 mx-auto mb-4 opacity-50" />
                        <p className="text-lg mb-2">{priceHistorySearchQuery ? 'No ingredients found' : 'No price history yet'}</p>
                        <p className="text-sm">{priceHistorySearchQuery ? 'Try a different search term' : 'Prices will be automatically tracked when you update them on your shopping list'}</p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {ingredientsWithHistory
                          .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))
                          .map((ingredient) => (
                            <div 
                              key={ingredient.name}
                              onClick={() => setSelectedIngredient(ingredient.name)}
                              className={`p-4 rounded-lg cursor-pointer transition-colors ${
                                darkMode 
                                  ? 'bg-gray-700 hover:bg-gray-600' 
                                  : 'bg-gray-50 hover:bg-gray-100'
                              }`}
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex-1">
                                  <h3 className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                    {ingredient.name}
                                  </h3>
                                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Last updated: {new Date(ingredient.lastUpdated).toLocaleDateString()}
                                  </p>
                                </div>
                                <div className="text-right">
                                  <p className={`text-lg font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                    NT${ingredient.currentPrice.toFixed(2)}
                                  </p>
                                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    per {ingredient.packageQuantity} {ingredient.packageUnit}
                                  </p>
                                  <div className={`text-sm font-medium mt-1 ${
                                    ingredient.priceChange > 10 
                                      ? 'text-red-500' 
                                      : ingredient.priceChange < -10 
                                      ? 'text-green-500' 
                                      : darkMode ? 'text-gray-400' : 'text-gray-600'
                                  }`}>
                                    {ingredient.priceChange > 0 ? 'â†‘' : ingredient.priceChange < 0 ? 'â†“' : 'â†’'} {Math.abs(ingredient.priceChange).toFixed(1)}% vs avg
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                      </div>
                    )}
                  </div>
                </div>
                
                {/* Scroll to Top Button */}
                {showScrollTop && (
                  <button
                    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                    className={`fixed bottom-6 right-6 p-3 rounded-full shadow-lg z-50 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                    title="Scroll to top"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                  </button>
                )}
              </div>
            );
          }

          if (showManageRecipes) {
            return (
              <div className={`min-h-screen p-4 md:p-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                <div className="max-w-4xl mx-auto">
                  <div className={`rounded-lg shadow-sm border mb-6 p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <Settings className={`w-8 h-8 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
                        <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Manage Recipes</h1>
                      </div>
                      <button
                        onClick={() => setShowManageRecipes(false)}
                        className={`px-4 py-2 ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'}`}
                      >
                        Back to Shopping List
                      </button>
                    </div>
                    
                    {/* Main action buttons */}
                    <div className="space-y-3">
                      <button
                        onClick={startNewRecipe}
                        className={`w-full px-4 py-3 rounded-lg font-medium ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                      >
                        + Add New Recipe
                      </button>
                      
                      {/* Import/Export buttons */}
                      <div className="grid grid-cols-2 gap-3">
                        <button
                          onClick={exportRecipes}
                          disabled={recipes.length === 0}
                          className={`flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white disabled:bg-gray-800 disabled:text-gray-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-700 disabled:bg-gray-50 disabled:text-gray-400'}`}
                          title="Export all recipes to JSON file"
                        >
                          <Download className="w-4 h-4" />
                          <span className="hidden sm:inline">Export</span>
                        </button>
                        <button
                          onClick={importRecipes}
                          className={`flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                          title="Import recipes from JSON file (merge with existing)"
                        >
                          <Upload className="w-4 h-4" />
                          <span className="hidden sm:inline">Import</span>
                        </button>
                      </div>
                      
                      {recipes.length > 0 && (
                        <button
                          onClick={replaceAllRecipes}
                          className={`w-full px-3 py-2 text-sm rounded-lg font-medium transition-colors ${darkMode ? 'bg-red-900/20 hover:bg-red-900/30 text-red-400 border border-red-800' : 'bg-red-50 hover:bg-red-100 text-red-600 border border-red-200'}`}
                          title="Replace all recipes with imported file"
                        >
                          âš ï¸ Replace All Recipes
                        </button>
                      )}
                    </div>
                  </div>

                  <div className="space-y-4">
                    {recipes.length === 0 ? (
                      <div className={`text-center py-12 rounded-lg border mt-6 ${darkMode ? 'bg-gray-800 border-gray-700 text-gray-400' : 'bg-white border-gray-200 text-gray-500'}`}>
                        <p className="mb-2">No recipes yet</p>
                        <p className="text-sm">Add a new recipe or import from a backup file</p>
                      </div>
                    ) : (
                      recipes.map(recipe => (
                      <div key={recipe.id} className={`rounded-lg shadow-sm border p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <h3 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{recipe.name}</h3>
                            <p className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                              {recipe.ingredients.length} ingredient{recipe.ingredients.length !== 1 ? 's' : ''}
                            </p>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => duplicateRecipe(recipe)}
                              className={`p-2 rounded ${darkMode ? 'text-green-400 hover:bg-gray-700' : 'text-green-600 hover:bg-green-50'}`}
                              title="Duplicate recipe"
                            >
                              <Copy className="w-5 h-5" />
                            </button>
                            <button
                              onClick={() => startEditRecipe(recipe)}
                              className={`p-2 rounded ${darkMode ? 'text-blue-400 hover:bg-gray-700' : 'text-blue-600 hover:bg-blue-50'}`}
                              title="Edit recipe"
                            >
                              <Edit className="w-5 h-5" />
                            </button>
                            <button
                              onClick={() => deleteRecipe(recipe.id)}
                              className={`p-2 rounded ${darkMode ? 'text-red-400 hover:bg-gray-700' : 'text-red-600 hover:bg-red-50'}`}
                              title="Delete recipe"
                            >
                              <Trash className="w-5 h-5" />
                            </button>
                          </div>
                        </div>
                        <div className={`mt-4 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          <div className="grid grid-cols-2 gap-2">
                            {(expandedRecipes[recipe.id] ? recipe.ingredients : recipe.ingredients.slice(0, 6)).map((ing, i) => (
                              <div key={i} className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                â€¢ {ing.name}
                              </div>
                            ))}
                          </div>
                          {recipe.ingredients.length > 6 && (
                            <button
                              onClick={() => setExpandedRecipes(prev => ({ ...prev, [recipe.id]: !prev[recipe.id] }))}
                              className={`text-sm mt-2 ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} cursor-pointer hover:underline`}
                            >
                              {expandedRecipes[recipe.id] 
                                ? 'â–² Show less' 
                                : `â–¼ ... and ${recipe.ingredients.length - 6} more`}
                            </button>
                          )}
                        </div>
                      </div>
                    )))}
                  </div>
                </div>
                
                {/* Scroll to Top Button */}
                {showScrollTop && (
                  <button
                    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                    className={`fixed bottom-6 right-6 p-3 rounded-full shadow-lg z-50 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                    title="Scroll to top"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                  </button>
                )}
              </div>
            );
          }

          // Quick Log Modal
          if (showQuickLog) {
            const purchasedList = aggregatedIngredients.filter(ing => purchasedItems.has(ing.name));
            const newItemsToLog = purchasedList.filter(ing => !loggedItems.has(ing.name));
            const alreadyLoggedCount = purchasedList.length - newItemsToLog.length;

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                <div className={`rounded-lg shadow-xl max-w-md w-full my-8 max-h-[90vh] overflow-y-auto ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className={`p-6 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                    <div className="flex items-center justify-between">
                      <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        ðŸ’° Quick Log Trip
                      </h2>
                      <button
                        onClick={() => {
                          const scrollY = window.scrollY;
                          setShowQuickLog(false);
                          setTimeout(() => window.scrollTo(0, scrollY), 0);
                        }}
                        className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-600'}`}
                      >
                        <X className="w-6 h-6" />
                      </button>
                    </div>
                  </div>
                  
                  <div className="p-6 space-y-4">
                    <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {newItemsToLog.length > 0 ? (
                        <>
                          {newItemsToLog.length} new item{newItemsToLog.length !== 1 ? 's' : ''} to log
                          {alreadyLoggedCount > 0 && (
                            <span className={`block text-xs mt-1 ${darkMode ? 'text-yellow-400' : 'text-orange-600'}`}>
                              ({alreadyLoggedCount} already logged previously)
                            </span>
                          )}
                        </>
                      ) : (
                        <span className={darkMode ? 'text-yellow-400' : 'text-orange-600'}>
                          All {purchasedList.length} checked item{purchasedList.length !== 1 ? 's have' : ' has'} already been logged
                        </span>
                      )}
                    </div>

                    {/* Show items being logged */}
                    {newItemsToLog.length > 0 && (
                      <div className={`p-3 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200'}`}>
                        <div className={`text-xs font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Items to log:
                        </div>
                        <div className="max-h-32 overflow-y-auto">
                          <ul className={`text-sm space-y-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {newItemsToLog.map(item => (
                              <li key={item.name} className="flex items-center gap-2">
                                <span className="text-green-500">âœ“</span>
                                <span>{item.name}</span>
                                {item.hasQuantity && (
                                  <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                    ({formatAmount(item.total)} {item.unit})
                                  </span>
                                )}
                              </li>
                            ))}
                          </ul>
                        </div>
                      </div>
                    )}

                    {/* Calculate total from entered prices */}
                    {(() => {
                      const itemsWithPrices = newItemsToLog.filter(item => {
                        const priceData = ingredientPrices[item.name];
                        // Accept price if it exists, regardless of packageQuantity for Quick Add items
                        if (item.hasQuantity) {
                          return priceData?.price > 0 && priceData?.packageQuantity > 0;
                        } else {
                          // For Quick Add items without quantities, just check if price exists
                          return priceData?.price > 0;
                        }
                      });
                      
                      const itemsWithoutPrices = newItemsToLog.filter(item => {
                        const priceData = ingredientPrices[item.name];
                        if (item.hasQuantity) {
                          return !(priceData?.price > 0 && priceData?.packageQuantity > 0);
                        } else {
                          return !(priceData?.price > 0);
                        }
                      });

                      const convertToBaseUnit = (qty, unit) => {
                        const lowerUnit = unit.toLowerCase();
                        if (lowerUnit === 'kg') return qty * 1000;
                        if (lowerUnit === 'æ–¤') return qty * 600;
                        if (lowerUnit === 'lb') return qty * 453.592;
                        if (lowerUnit === 'oz') return qty * 28.3495;
                        if (lowerUnit === 'l') return qty * 1000;
                        return qty;
                      };

                      // Quick Log always uses flat package prices (what you paid at the store)
                      let calculatedTotal = 0;
                      itemsWithPrices.forEach(item => {
                        const priceData = ingredientPrices[item.name];
                        calculatedTotal += parseFloat(priceData.price);
                      });

                      const hasCalculatedTotal = itemsWithPrices.length > 0;
                      const hasMissingPrices = itemsWithoutPrices.length > 0;

                      return (
                        <>
                          {/* Calculated Total Display */}
                          {hasCalculatedTotal && (
                            <div className={`p-3 rounded-lg border ${darkMode ? 'bg-blue-900/20 border-blue-700' : 'bg-blue-50 border-blue-200'}`}>
                              <div className={`text-sm font-medium ${darkMode ? 'text-blue-300' : 'text-blue-700'}`}>
                                ðŸ’° Calculated from {itemsWithPrices.length} item{itemsWithPrices.length !== 1 ? 's' : ''} with prices:
                              </div>
                              <div className={`text-2xl font-bold mt-1 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                NT$ {Math.round(calculatedTotal)}
                              </div>
                              {hasMissingPrices && (
                                <div className={`text-xs mt-1 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                  (+ {itemsWithoutPrices.length} item{itemsWithoutPrices.length !== 1 ? 's' : ''} without prices)
                                </div>
                              )}
                            </div>
                          )}

                          {/* Missing Prices Warning */}
                          {hasMissingPrices && (
                            <div className={`p-3 rounded-lg border ${darkMode ? 'bg-yellow-900/20 border-yellow-700' : 'bg-yellow-50 border-yellow-300'}`}>
                              <div className={`text-sm font-medium ${darkMode ? 'text-yellow-300' : 'text-yellow-800'}`}>
                                âš  Missing prices for {itemsWithoutPrices.length} item{itemsWithoutPrices.length !== 1 ? 's' : ''}:
                              </div>
                              <div className="max-h-20 overflow-y-auto mt-1">
                                <ul className={`text-xs space-y-0.5 ${darkMode ? 'text-yellow-400' : 'text-yellow-700'}`}>
                                  {itemsWithoutPrices.map(item => (
                                    <li key={item.name}>â€¢ {item.name}</li>
                                  ))}
                                </ul>
                              </div>
                              <div className={`text-xs mt-2 ${darkMode ? 'text-yellow-400' : 'text-yellow-700'}`}>
                                ðŸ’¡ Add prices later in "Update Prices" to track costs
                              </div>
                            </div>
                          )}
                        </>
                      );
                    })()}

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        {(() => {
                          const itemsWithPrices = newItemsToLog.filter(item => {
                            const priceData = ingredientPrices[item.name];
                            return priceData?.price > 0;
                          });
                          return itemsWithPrices.length > 0 ? 'Actual Total (or edit calculated)' : 'Total Spent (TWD)';
                        })()}
                      </label>
                      <input
                        type="number"
                        value={tripTotal}
                        onChange={(e) => setTripTotal(e.target.value)}
                        placeholder={(() => {
                          const itemsWithPrices = newItemsToLog.filter(item => {
                            const priceData = ingredientPrices[item.name];
                            return priceData?.price > 0;
                          });
                          if (itemsWithPrices.length === 0) return '297';
                          
                          const convertToBaseUnit = (qty, unit) => {
                            const lowerUnit = unit.toLowerCase();
                            if (lowerUnit === 'kg') return qty * 1000;
                            if (lowerUnit === 'æ–¤') return qty * 600;
                            if (lowerUnit === 'lb') return qty * 453.592;
                            if (lowerUnit === 'oz') return qty * 28.3495;
                            if (lowerUnit === 'l') return qty * 1000;
                            return qty;
                          };
                          
                          let calculatedTotal = 0;
                          itemsWithPrices.forEach(item => {
                            const priceData = ingredientPrices[item.name];
                            calculatedTotal += parseFloat(priceData.price);
                          });
                          
                          return Math.round(calculatedTotal).toString();
                        })()}
                        className={`w-full px-4 py-3 text-lg border rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                      <div className={`text-xs mt-1 ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                        {(() => {
                          const itemsWithPrices = newItemsToLog.filter(item => {
                            const priceData = ingredientPrices[item.name];
                            return priceData?.price > 0 && priceData?.packageQuantity > 0 && item.hasQuantity;
                          });
                          return itemsWithPrices.length > 0 
                            ? 'Auto-filled from item prices. Edit if your receipt total differs.'
                            : 'Enter the total from your receipt';
                        })()}
                      </div>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Vendor
                      </label>
                      <div className="flex gap-2">
                        <select
                          value={selectedVendor}
                          onChange={(e) => setSelectedVendor(e.target.value)}
                          className={`flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        >
                          {vendors.map(vendor => (
                            <option key={vendor} value={vendor}>{vendor}</option>
                          ))}
                          <option value="__custom__">+ Add New Vendor...</option>
                        </select>
                        {selectedVendor === '__custom__' && (
                          <input
                            type="text"
                            placeholder="Enter vendor name"
                            autoFocus
                            onBlur={(e) => {
                              const newVendor = e.target.value.trim();
                              if (newVendor && !vendors.includes(newVendor)) {
                                setVendors(prev => [...prev, newVendor]);
                                setSelectedVendor(newVendor);
                              } else if (newVendor) {
                                setSelectedVendor(newVendor);
                              } else {
                                setSelectedVendor(vendors[0] || '');
                              }
                            }}
                            onKeyPress={(e) => {
                              if (e.key === 'Enter') {
                                e.target.blur();
                              }
                            }}
                            className={`flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          />
                        )}
                      </div>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Date
                      </label>
                      <input
                        type="date"
                        value={tripDate}
                        onChange={(e) => setTripDate(e.target.value)}
                        className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                    </div>

                    <div className="flex gap-3 pt-4">
                      <button
                        onClick={() => {
                          const result = saveQuickTrip(tripTotal, selectedVendor, tripDate);
                          if (result) {
                            // Save current scroll position
                            const scrollY = window.scrollY;
                            setShowQuickLog(false);
                            setTripTotal('');
                            // Restore scroll position after modal closes
                            setTimeout(() => {
                              window.scrollTo(0, scrollY);
                            }, 0);
                            alert(`âœ“ Trip saved! ${result.itemCount} item${result.itemCount !== 1 ? 's' : ''} logged.`);
                          }
                          // If result is null, saveQuickTrip already showed an alert
                        }}
                        disabled={!tripTotal}
                        className={`flex-1 px-6 py-3 rounded-lg font-medium ${tripTotal ? (darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white') : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                      >
                        Save Trip
                      </button>
                      <button
                        onClick={() => {
                          const scrollY = window.scrollY;
                          setShowQuickLog(false);
                          setTimeout(() => window.scrollTo(0, scrollY), 0);
                        }}
                        className={`px-6 py-3 border rounded-lg font-medium ${darkMode ? 'border-gray-600 hover:bg-gray-700 text-gray-300' : 'border-gray-300 hover:bg-gray-50'}`}
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // Manage Vendors Modal
          if (showManageVendors) {
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className={`rounded-lg shadow-xl max-w-2xl w-full ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <div className={`p-6 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                    <div className="flex items-center justify-between">
                      <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        âœï¸ Manage Vendors
                      </h2>
                      <button
                        onClick={() => setShowManageVendors(false)}
                        className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-600'}`}
                      >
                        <X className="w-6 h-6" />
                      </button>
                    </div>
                  </div>
                  
                  <div className="p-6 space-y-4">
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Edit vendors (one per line):
                      </label>
                      <textarea
                        value={vendorEditText}
                        onChange={(e) => setVendorEditText(e.target.value)}
                        rows={12}
                        placeholder="Street Market - Veggies&#10;Big King&#10;RT-Mart"
                        className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        autoFocus
                      />
                      <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        ðŸ’¡ Tip: Each line becomes a vendor option in the dropdown
                      </p>
                    </div>

                    <div className="flex gap-3 pt-4">
                      <button
                        onClick={() => {
                          const newVendors = vendorEditText.split('\n').map(v => v.trim()).filter(v => v);
                          if (newVendors.length > 0) {
                            setVendors(newVendors);
                            setShowManageVendors(false);
                            alert(`âœ“ Vendors updated! ${newVendors.length} vendor${newVendors.length !== 1 ? 's' : ''} saved.`);
                          } else {
                            alert('âš ï¸ Please enter at least one vendor.');
                          }
                        }}
                        className={`flex-1 px-6 py-3 rounded-lg font-medium ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                      >
                        Save Vendors
                      </button>
                      <button
                        onClick={() => setShowManageVendors(false)}
                        className={`px-6 py-3 border rounded-lg font-medium ${darkMode ? 'border-gray-600 hover:bg-gray-700 text-gray-300' : 'border-gray-300 hover:bg-gray-50'}`}
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // Help Modal
          if (showHelp) {
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => {
                setShowHelp(false);
                setTimeout(() => window.scrollTo(0, scrollPositionBeforeHelp), 0);
              }}>
                <div className={`rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto ${darkMode ? 'bg-gray-800' : 'bg-white'}`} onClick={(e) => e.stopPropagation()}>
                  <div className={`p-6 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} sticky top-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} z-10`}>
                    <div className="flex items-center justify-between">
                      <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        â“ Button Guide
                      </h2>
                      <button
                        onClick={() => {
                          setShowHelp(false);
                          setTimeout(() => window.scrollTo(0, scrollPositionBeforeHelp), 0);
                        }}
                        className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-600'}`}
                      >
                        <X className="w-6 h-6" />
                      </button>
                    </div>
                  </div>
                  
                  <div className="p-6 space-y-6">
                    <div className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Main Navigation Buttons</h3>
                      
                      <div className="space-y-4">
                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <TrendingUp className="w-5 h-5 text-blue-600" />
                            <span className="font-semibold">Price History</span>
                          </div>
                          <p className="text-sm">View charts showing price changes over time. Track if ingredient costs are rising or falling.</p>
                        </div>

                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-green-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <DollarSign className="w-5 h-5 text-green-600" />
                            <span className="font-semibold">Update Prices</span>
                          </div>
                          <p className="text-sm">Enter or edit prices for ingredients. Use this AFTER shopping to record what you actually paid at the store. Different from "Load Prices" which fills in old prices.</p>
                        </div>

                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <Settings className="w-5 h-5 text-gray-600" />
                            <span className="font-semibold">Manage Recipes</span>
                          </div>
                          <p className="text-sm">Add, edit, or delete recipes. Manage your ingredient lists and measurements.</p>
                        </div>

                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <ShoppingCart className="w-5 h-5 text-blue-600" />
                            <span className="font-semibold">Trip History</span>
                          </div>
                          <p className="text-sm">See all your shopping trips with dates, vendors, totals, and items. Export to CSV for accounting in Apple Numbers.</p>
                        </div>

                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-purple-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <Store className="w-5 h-5 text-purple-600" />
                            <span className="font-semibold">Vendors</span>
                          </div>
                          <p className="text-sm">Add, edit, or remove vendor names. Automatically syncs with recipe locations and trip logging.</p>
                        </div>
                      </div>

                      <h3 id="help-action-buttons" className={`text-lg font-bold mb-4 mt-8 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Shopping List Action Buttons</h3>
                      
                      <div className="space-y-4">
                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-xl">ðŸ’¡</span>
                            <span className="font-semibold text-blue-600">Automatic Price Loading</span>
                          </div>
                          <p className="text-sm"><strong>How it works:</strong> When you select recipes, prices from your last shopping trip automatically appear in the shopping list. No button needed!</p>
                          <p className="text-sm mt-2 italic">Example: Select "Ayam Goreng" recipe â†’ Prices auto-fill instantly â†’ See estimated cost right away.</p>
                        </div>

                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-green-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-xl">ðŸ’°</span>
                            <span className="font-semibold text-green-600">Quick Log</span>
                          </div>
                          <p className="text-sm"><strong>AFTER shopping:</strong> Saves checked items as a shopping trip. Records vendor, total spent, date, and items. Use for expense tracking.</p>
                          <p className="text-sm mt-2 italic">Example: At store, check off items as you buy. Enter total NT$297, click "Quick Log", done!</p>
                        </div>

                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-red-50'}`}>
                          <div className="flex items-center gap-2 mb-2">
                            <RefreshCw className="w-5 h-5 text-red-600" />
                            <span className="font-semibold text-red-600">Reset</span>
                          </div>
                          <p className="text-sm"><strong>After shopping:</strong> Unchecks all items and clears the shopping list. Use when done shopping to start fresh next time.</p>
                          <p className="text-sm mt-2 italic">Example: Finished shopping for the week. Click "Reset" to clear everything for next trip.</p>
                        </div>
                      </div>

                      <h3 className={`text-lg font-bold mb-4 mt-8 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Common Questions</h3>
                      
                      <div className="space-y-3 text-sm">
                        <div className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-yellow-50'}`}>
                          <p className="font-semibold">Q: How do prices get into my shopping list?</p>
                          <p className="mt-1"><strong>Automatically!</strong> When you select recipes, prices from your last shopping trip automatically appear. No extra steps needed.</p>
                          <p className="mt-2"><strong>Update Prices button:</strong> Use this AFTER shopping to save new prices you paid at the store.</p>
                        </div>

                        <div className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-yellow-50'}`}>
                          <p className="font-semibold">Q: When should I use "Quick Log"?</p>
                          <p className="mt-1">Use Quick Log when you want to track expenses. It records what you spent at each vendor. Great for accounting!</p>
                        </div>

                        <div className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-yellow-50'}`}>
                          <p className="font-semibold">Q: What does "Reset" do exactly?</p>
                          <p className="mt-1">Unchecks all items and clears prices from the shopping list view. Your saved prices in "Update Prices" are NOT deleted. Use this to start fresh after shopping.</p>
                        </div>
                      </div>
                    </div>

                    <div className="flex justify-center pt-4">
                      <button
                        onClick={() => setShowHelp(false)}
                        className={`px-8 py-3 rounded-lg font-medium ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                      >
                        Got it!
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // Trip History View
          if (showTripHistory) {
            const thisMonthTrips = shoppingTrips.filter(trip => {
              const tripMonth = new Date(trip.date).getMonth();
              const currentMonth = new Date().getMonth();
              return tripMonth === currentMonth;
            });
            const thisMonthTotal = thisMonthTrips.reduce((sum, trip) => sum + (trip.total || 0), 0);

            return (
              <div className={`min-h-screen p-4 md:p-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                <div className="max-w-4xl mx-auto">
                  {/* Header */}
                  <div className={`rounded-lg shadow-sm border mb-6 p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <ShoppingCart className={`w-8 h-8 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
                        <div>
                          <h1 className={`text-2xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Trip History</h1>
                          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            {shoppingTrips.length} trips recorded
                          </p>
                        </div>
                      </div>
                      <button
                        onClick={() => setShowTripHistory(false)}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                      >
                        <ArrowLeft className="w-5 h-5" />
                        Back
                      </button>
                    </div>

                    {thisMonthTrips.length > 0 && (
                      <div className={`p-4 rounded-lg ${darkMode ? 'bg-blue-900/20 border border-blue-800' : 'bg-blue-50 border border-blue-200'}`}>
                        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>This Month</div>
                        <div className={`text-2xl font-bold mt-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {thisMonthTrips.length} trips Â· NT$ {thisMonthTotal.toLocaleString()}
                        </div>
                      </div>
                    )}

                    <div className="flex gap-2 mt-4">
                      <button
                        onClick={exportTripsToCSV}
                        disabled={shoppingTrips.length === 0}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg ${shoppingTrips.length > 0 ? (darkMode ? 'bg-green-700 hover:bg-green-600 text-white' : 'bg-green-600 hover:bg-green-700 text-white') : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                      >
                        <Download className="w-4 h-4" />
                        Export to CSV
                      </button>
                      <button
                        onClick={() => {
                          const newVendor = prompt('Add new vendor:', '');
                          if (newVendor && newVendor.trim() && !vendors.includes(newVendor.trim())) {
                            setVendors(prev => [...prev, newVendor.trim()]);
                          }
                        }}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg ${darkMode ? 'bg-blue-700 hover:bg-blue-600 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                      >
                        + Add Vendor
                      </button>
                      <button
                        onClick={() => {
                          setVendorEditText(vendors.join('\n'));
                          setShowManageVendors(true);
                        }}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-200 hover:bg-gray-300 text-gray-700'}`}
                      >
                        âœï¸ Manage Vendors
                      </button>
                    </div>
                  </div>

                  {/* Trip List */}
                  <div className="space-y-4">
                    {shoppingTrips.length === 0 ? (
                      <div className={`text-center py-12 rounded-lg border ${darkMode ? 'bg-gray-800 border-gray-700 text-gray-400' : 'bg-white border-gray-200 text-gray-500'}`}>
                        <ShoppingCart className="w-16 h-16 mx-auto mb-4 opacity-20" />
                        <p>No shopping trips recorded yet</p>
                        <p className="text-sm mt-2">Check off purchased items and click "Quick Log" to save your first trip</p>
                      </div>
                    ) : (
                      shoppingTrips.map(trip => (
                        <div
                          key={trip.id}
                          className={`rounded-lg shadow-sm border p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                        >
                          {editingTrip?.id === trip.id ? (
                            // Edit mode
                            <div className="space-y-3">
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                  <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Vendor
                                  </label>
                                  <select
                                    value={editingTrip.vendor}
                                    onChange={(e) => setEditingTrip({...editingTrip, vendor: e.target.value})}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                  >
                                    {vendors.map(v => (
                                      <option key={v} value={v}>{v}</option>
                                    ))}
                                  </select>
                                </div>
                                <div>
                                  <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Total (NT$)
                                  </label>
                                  <input
                                    type="number"
                                    value={editingTrip.total}
                                    onChange={(e) => setEditingTrip({...editingTrip, total: parseFloat(e.target.value) || 0})}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                    step="0.01"
                                  />
                                </div>
                                <div>
                                  <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Date
                                  </label>
                                  <input
                                    type="date"
                                    value={editingTrip.date}
                                    onChange={(e) => setEditingTrip({...editingTrip, date: e.target.value})}
                                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                  />
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => {
                                    updateTrip(editingTrip.id, {
                                      vendor: editingTrip.vendor,
                                      total: editingTrip.total,
                                      date: editingTrip.date
                                    });
                                    setEditingTrip(null);
                                  }}
                                  className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                                >
                                  Save
                                </button>
                                <button
                                  onClick={() => setEditingTrip(null)}
                                  className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-700'}`}
                                >
                                  Cancel
                                </button>
                              </div>
                            </div>
                          ) : (
                            // Display mode
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                  <div className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                    {trip.vendor || 'Unknown Vendor'}
                                  </div>
                                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    {new Date(trip.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                  </div>
                                </div>
                                <div className={`text-2xl font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                  NT$ {trip.total?.toLocaleString() || 'â€”'}
                                </div>
                                <div className={`text-sm mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  {trip.itemCount || trip.items?.length || 0} items purchased
                                </div>
                                {trip.items && trip.items.length > 0 && (
                                  <details className="mt-3">
                                    <summary className={`cursor-pointer text-sm ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}>
                                      View items
                                    </summary>
                                    <div className={`mt-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                      {trip.items.map((item, idx) => (
                                        <div key={idx} className="py-1">
                                          â€¢ {item.name} ({item.quantity}{item.unit})
                                        </div>
                                      ))}
                                    </div>
                                  </details>
                                )}
                              </div>
                              <div className="flex gap-1">
                                <button
                                  onClick={() => setEditingTrip({
                                    id: trip.id,
                                    vendor: trip.vendor,
                                    total: trip.total,
                                    date: trip.date
                                  })}
                                  className={`p-2 rounded ${darkMode ? 'hover:bg-gray-700 text-blue-400' : 'hover:bg-blue-50 text-blue-600'}`}
                                  title="Edit trip"
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                  </svg>
                                </button>
                                <button
                                  onClick={() => deleteTrip(trip.id)}
                                  className={`p-2 rounded ${darkMode ? 'hover:bg-gray-700 text-red-400' : 'hover:bg-red-50 text-red-600'}`}
                                  title="Delete trip"
                                >
                                  <X className="w-5 h-5" />
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      ))
                    )}
                  </div>
                </div>
                
                {/* Scroll to Top Button */}
                {showScrollTop && (
                  <button
                    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                    className={`fixed bottom-6 right-6 p-3 rounded-full shadow-lg z-50 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                    title="Scroll to top"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                  </button>
                )}
              </div>
            );
          }

          return (
            <div className={`min-h-screen p-4 md:p-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
              <div className="max-w-6xl mx-auto">
                <div className={`rounded-lg shadow-sm border mb-6 p-4 md:p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                  <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-2">
                    <div className="flex items-center gap-2 md:gap-3">
                      <ShoppingCart className={`w-6 h-6 md:w-8 md:h-8 flex-shrink-0 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
                      <h1 className={`text-xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Shopping List</h1>
                    </div>
                    <div className="flex gap-2 flex-wrap justify-end">
                      <button
                        onClick={() => setShowHelp(true)}
                        className={`p-2 rounded-lg flex-shrink-0 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-blue-400' : 'bg-gray-100 hover:bg-gray-200 text-blue-600'}`}
                        title="Show button help guide"
                      >
                        <HelpCircle className="w-5 h-5" />
                      </button>
                      <button
                        onClick={() => setDarkMode(!darkMode)}
                        className={`p-2 rounded-lg flex-shrink-0 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-yellow-400' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                        title={darkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                      >
                        {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                      </button>
                      <button
                        onClick={() => setShowPriceHistory(true)}
                        className={`flex items-center gap-1 px-2 py-2 md:px-4 rounded-lg font-medium text-sm md:text-base flex-shrink-0 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                        title="ðŸ“ˆ Price History: See price changes over time with charts. Track if ingredient costs are going up or down."
                      >
                        <TrendingUp className="w-4 h-4 md:w-5 md:h-5" />
                        <span className="hidden md:inline">Price History</span>
                        <span className="md:hidden">History</span>
                      </button>
                      <button
                        onClick={() => {
                          // Initialize ingredientPrices with package quantity/unit only (not price)
                          // Price field should start empty to avoid accidental duplicate entries
                          const initialPrices = {};
                          Object.entries(lastKnownPrices).forEach(([name, data]) => {
                            initialPrices[name] = {
                              price: null, // Start empty - user must enter new price
                              packageQuantity: data.packageQuantity,
                              packageUnit: data.packageUnit
                            };
                          });
                          setIngredientPrices(initialPrices);
                          setShowPriceManagement(true);
                        }}
                        className={`flex items-center gap-1 px-2 py-2 md:px-4 rounded-lg font-medium text-sm md:text-base flex-shrink-0 ${darkMode ? 'bg-green-700 hover:bg-green-600 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                        title="ðŸ’² Update Prices: Enter/edit prices for ingredients. Opens a form to record what you paid at the store."
                      >
                        <DollarSign className="w-4 h-4 md:w-5 md:h-5" />
                        <span className="hidden md:inline">Update Prices</span>
                        <span className="md:hidden">Prices</span>
                      </button>
                      <button
                        onClick={() => setShowManageRecipes(true)}
                        className={`flex items-center gap-1 px-2 py-2 md:px-4 rounded-lg font-medium text-sm md:text-base flex-shrink-0 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                      >
                        <Settings className="w-4 h-4 md:w-5 md:h-5" />
                        <span className="hidden md:inline">Manage Recipes</span>
                        <span className="md:hidden">Recipes</span>
                      </button>
                      <button
                        onClick={() => setShowTripHistory(true)}
                        className={`flex items-center gap-1 px-2 py-2 md:px-4 rounded-lg font-medium text-sm md:text-base flex-shrink-0 ${darkMode ? 'bg-blue-700 hover:bg-blue-600 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                        title="ðŸ›’ Trip History: See all your shopping trips with dates, vendors, totals, and items. Export to CSV for accounting."
                      >
                        <ShoppingCart className="w-4 h-4 md:w-5 md:h-5" />
                        <span className="hidden md:inline">Trip History</span>
                        <span className="md:hidden">Trips</span>
                      </button>
                      <button
                        onClick={() => {
                          setVendorEditText(vendors.join('\n'));
                          setShowManageVendors(true);
                        }}
                        className={`flex items-center gap-1 px-2 py-2 md:px-4 rounded-lg font-medium text-sm md:text-base flex-shrink-0 ${darkMode ? 'bg-purple-700 hover:bg-purple-600 text-white' : 'bg-purple-600 hover:bg-purple-700 text-white'}`}
                        title="ðŸª Vendors: Add, edit, or remove vendor names. Syncs with recipe locations and trip logging."
                      >
                        <Store className="w-4 h-4 md:w-5 md:h-5" />
                        <span className="hidden md:inline">Vendors</span>
                        <span className="md:hidden">Vendors</span>
                      </button>
                      <button
                        onClick={exportShoppingList}
                        className={`flex items-center gap-1 px-2 py-2 md:px-4 rounded-lg font-medium text-sm md:text-base flex-shrink-0 ${darkMode ? 'bg-indigo-700 hover:bg-indigo-600 text-white' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}
                        title="ðŸ“¤ Export: Copy shopping list to clipboard for sharing via LINE, Notes, or messaging apps."
                      >
                        <Share className="w-4 h-4 md:w-5 md:h-5" />
                        <span className="hidden md:inline">Export</span>
                        <span className="md:hidden">Share</span>
                      </button>
                      <button
                        onClick={completeShoppingTrip}
                        className={`flex items-center gap-1 px-2 py-2 md:px-4 rounded-lg font-medium text-sm md:text-base flex-shrink-0 ${darkMode ? 'bg-red-700 hover:bg-red-600 text-white' : 'bg-red-600 hover:bg-red-700 text-white'}`}
                        title="âœ… Complete Trip: Clear all items and reset for next shopping trip."
                      >
                        <CheckCircle className="w-4 h-4 md:w-5 md:h-5" />
                        <span className="hidden md:inline">Complete Trip</span>
                        <span className="md:hidden">Complete</span>
                      </button>
                    </div>
                  </div>
                  <p className={`text-sm md:text-base ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Select recipes and specify batch quantities to generate your shopping list</p>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  {/* Recipe Selection Panel */}
                  <div className={`rounded-lg shadow-sm border p-4 md:p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="flex items-center justify-between mb-4">
                      <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Select Recipes</h2>
                      {recipes.length > 0 && (
                        <button
                          onClick={selectAllRecipes}
                          className={`px-3 py-1.5 text-sm rounded-lg font-medium transition-colors ${
                            darkMode 
                              ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                              : 'bg-blue-500 hover:bg-blue-600 text-white'
                          }`}
                        >
                          Select All
                        </button>
                      )}
                    </div>
                    {recipes.length === 0 ? (
                      <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        <p>No recipes yet. Click "Manage Recipes" to add some!</p>
                      </div>
                    ) : (
                      <>
                        {/* Search input */}
                        {recipes.length > 3 && (
                          <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="Search recipes..."
                            className={`w-full px-4 py-2 mb-4 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                          />
                        )}
                        
                        <div className="space-y-3">
                          {filteredRecipes.length === 0 ? (
                            <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              <p>No recipes match "{searchQuery}"</p>
                            </div>
                          ) : (
                            filteredRecipes.map(recipe => {
                              const isSelected = selectedRecipes[recipe.id] !== undefined;
                              const batches = selectedRecipes[recipe.id] || 1;

                              return (
                                <div key={recipe.id} className={`border rounded-lg p-4 transition-colors ${darkMode ? 'border-gray-700 hover:border-blue-500' : 'border-gray-200 hover:border-blue-300'}`}>
                                  <div className="flex items-start gap-3">
                                    <input
                                      type="checkbox"
                                      checked={isSelected}
                                      onChange={() => toggleRecipe(recipe.id)}
                                      className="w-5 h-5 mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    />
                                    <div className="flex-1">
                                      <div className="flex items-center justify-between">
                                        <label className={`font-medium cursor-pointer ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                          {recipe.name}
                                        </label>
                                        <button
                                          onClick={() => toggleFavorite(recipe.id)}
                                          className={`p-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                                          title={recipe.isFavorite ? "Remove from favorites" : "Add to favorites"}
                                        >
                                          <Star 
                                            className={`w-5 h-5 ${recipe.isFavorite ? 'text-yellow-500' : darkMode ? 'text-gray-500' : 'text-gray-400'}`}
                                            filled={recipe.isFavorite}
                                          />
                                        </button>
                                      </div>
                                      <div className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                        {recipe.ingredients.length} ingredients
                                      </div>
                                      {recipe.notes && (
                                        <div className={`text-sm mt-1 italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                          {recipe.notes}
                                        </div>
                                      )}
                                      
                                      {isSelected && (
                                        <div className="mt-3 flex items-center gap-2">
                                          <button
                                            onClick={() => updateBatches(recipe.id, batches - 0.5)}
                                            className={`p-1 rounded border disabled:opacity-50 text-gray-400 ${darkMode ? 'border-gray-600 hover:bg-gray-700 hover:text-gray-300' : 'border-gray-300 hover:bg-gray-100 hover:text-gray-600'}`}
                                            disabled={batches <= 0.5}
                                          >
                                            <Minus className="w-4 h-4" />
                                          </button>
                                          <input
                                            type="number"
                                            min="0.5"
                                            step="0.5"
                                            value={batches}
                                            onChange={(e) => updateBatches(recipe.id, e.target.value)}
                                            className={`w-20 px-3 py-2 border rounded text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                          />
                                          <button
                                            onClick={() => updateBatches(recipe.id, batches + 0.5)}
                                            className={`p-1 rounded border text-gray-400 ${darkMode ? 'border-gray-600 hover:bg-gray-700 hover:text-gray-300' : 'border-gray-300 hover:bg-gray-100 hover:text-gray-600'}`}
                                          >
                                            <Plus className="w-4 h-4" />
                                          </button>
                                          <span className={`text-sm ml-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            {batches === 1 ? 'batch' : 'batches'}
                                          </span>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              );
                            })
                          )}
                        </div>
                      </>
                    )}
                  </div>

                  {/* Right column: Quick Add + Shopping List */}
                  <div className="space-y-6">
                    {/* Quick Add Items Panel */}
                    <div className={`rounded-lg shadow-sm border p-4 md:p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                      <h3 className={`text-lg font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        âš¡ Quick Add Items
                      </h3>
                      <p className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        Add one-off items without creating a recipe
                      </p>
                      <p className={`text-xs mb-4 px-3 py-2 rounded ${darkMode ? 'bg-blue-900/20 text-blue-300 border border-blue-800' : 'bg-blue-50 text-blue-700 border border-blue-200'}`}>
                        ðŸ’¡ <strong>Format:</strong> "salt 1000g" or "batteries 4 pcs" â†’ auto-fills quantity & unit
                      </p>
                    
                    <div className="flex gap-2 mb-4">
                      <input
                        type="text"
                        value={quickAddInput}
                        onChange={(e) => setQuickAddInput(e.target.value)}
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') {
                            handleQuickAdd();
                          }
                        }}
                        placeholder="e.g., salt, paper towels, batteries..."
                        list="all-ingredients-list"
                        className={`flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                      />
                      <button
                        onClick={handleQuickAdd}
                        disabled={!quickAddInput.trim()}
                        className={`px-4 py-2 rounded font-medium whitespace-nowrap ${quickAddInput.trim() ? (darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-600 text-white hover:bg-green-700') : (darkMode ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed')}`}
                      >
                        + Add
                      </button>
                    </div>

                    {/* Autocomplete datalist with all known ingredient names */}
                    <datalist id="all-ingredients-list">
                      {/* Get unique ingredient names from recipes */}
                      {Array.from(new Set(
                        recipes.flatMap(r => r.ingredients.map(ing => ing.name))
                      )).sort().map(name => (
                        <option key={name} value={name} />
                      ))}
                      {/* Also include any ingredients from last known prices */}
                      {Object.keys(lastKnownPrices).sort().map(name => (
                        <option key={name} value={name} />
                      ))}
                    </datalist>

                    {/* Display quick add items */}
                    {quickAddItems.length > 0 && (
                      <div className="space-y-2">
                        <div className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Quick Items ({quickAddItems.length}):
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {quickAddItems.map(item => (
                            <div 
                              key={item.name}
                              className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full border ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-200' : 'bg-gray-100 border-gray-300 text-gray-700'}`}
                            >
                              <span className="text-sm">
                                {item.name}
                                {item.quantity && (
                                  <span className={`ml-1.5 font-medium ${darkMode ? 'text-blue-300' : 'text-blue-600'}`}>
                                    {item.quantity}{item.unit}
                                  </span>
                                )}
                              </span>
                              <button
                                onClick={() => removeQuickAddItem(item.name)}
                                className={`hover:bg-red-500 hover:text-white rounded-full p-0.5 transition-colors ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                                title="Remove item"
                              >
                                <X className="w-3.5 h-3.5" />
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Shopping List Panel */}
                  <div className={`rounded-lg shadow-sm border p-4 md:p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                    <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
                      <div className="flex flex-col">
                        <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Shopping List</h2>
                        {hasSelections && estimatedTotal !== null && (
                          <div className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Estimated: <span className="font-semibold">{estimatedTotal.toLocaleString('zh-TW', { style: 'currency', currency: 'TWD' })}</span>
                            <span className="text-xs ml-1">(based on last prices)</span>
                          </div>
                        )}
                        {hasSelections && groupedByLocation.length > 0 && (
                          <div className={`text-sm mt-1 flex flex-wrap gap-x-2 gap-y-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            {groupedByLocation.map(({ location, items }) => (
                              <span key={location} className="whitespace-nowrap">
                                {location === 'Unspecified' ? 'ðŸ“' : 'ðŸ›’'} {location} ({items.length})
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                      <div className="flex items-center gap-2 flex-wrap">
                        <button
                          onClick={() => setShowQuickLog(true)}
                          disabled={purchasedItems.size === 0}
                          className={`flex items-center gap-1 px-3 py-2 rounded-lg font-medium text-sm ${
                            purchasedItems.size > 0
                              ? (darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white')
                              : (darkMode ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed')
                          }`}
                          title="ðŸ’° Quick Log: Save checked items as a shopping trip. Records vendor, total cost, and items purchased for expense tracking."
                        >
                          ðŸ’°
                          <span className="hidden sm:inline">Quick Log</span>
                        </button>
                        <button
                          onClick={clearPurchasedItems}
                          disabled={purchasedItems.size === 0}
                          className={`flex items-center gap-1 text-sm px-3 py-2 rounded-lg font-medium ${
                            purchasedItems.size > 0
                              ? (darkMode ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-red-600 hover:bg-red-700 text-white')
                              : (darkMode ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed')
                          }`}
                          title="ðŸ”„ Reset: Uncheck all items and clear the shopping list. Use after completing your shopping to start fresh."
                        >
                          <RefreshCw className="w-4 h-4" />
                          <span className="hidden sm:inline">Reset</span>
                        </button>
                        <button
                          onClick={() => {
                            setScrollPositionBeforeHelp(window.scrollY);
                            setShowHelp(true);
                            // Scroll to action buttons section after modal opens
                            setTimeout(() => {
                              const element = document.getElementById('help-action-buttons');
                              if (element) element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 100);
                          }}
                          className={`flex items-center gap-1 px-2 py-2 rounded-lg ${
                            darkMode ? 'bg-gray-700 hover:bg-gray-600 text-blue-400' : 'bg-gray-100 hover:bg-gray-200 text-blue-600'
                          }`}
                          title="â“ Help: What do these buttons do?"
                        >
                          <HelpCircle className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                    
                    {!hasSelections ? (
                      <div className="text-center py-12 text-gray-500">
                        <ShoppingCart className="w-16 h-16 mx-auto mb-4 opacity-20" />
                        <p>Select recipes to generate your shopping list</p>
                      </div>
                    ) : aggregatedIngredients.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p>No ingredients to display</p>
                      </div>
                    ) : (
                      <>
                        {/* Planned Purchase Cost Summary */}
                        {hasSelections && plannedPurchaseCost.itemCount > 0 && (
                          <div className={`rounded-lg border-2 p-4 mb-6 ${darkMode ? 'bg-blue-900/20 border-blue-700' : 'bg-blue-50 border-blue-300'}`}>
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <h3 className={`text-lg font-bold ${darkMode ? 'text-blue-300' : 'text-blue-900'}`}>
                                  PLANNED PURCHASE TOTAL
                                </h3>
                                <div className={`text-sm mt-1 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                                  {plannedPurchaseCost.itemCount} item{plannedPurchaseCost.itemCount !== 1 ? 's' : ''} selected
                                  {plannedPurchaseCost.itemsWithPrices > 0 && (
                                    <span> ({plannedPurchaseCost.itemsWithPrices} with price{plannedPurchaseCost.itemsWithPrices !== 1 ? 's' : ''}
                                    {plannedPurchaseCost.itemsWithoutPrices.length > 0 && `, ${plannedPurchaseCost.itemsWithoutPrices.length} without`})</span>
                                  )}
                                </div>
                              </div>
                              <div className="flex flex-col items-end gap-2">
                                <button
                                  onClick={selectAllForPurchase}
                                  className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-blue-700 hover:bg-blue-600 text-white' : 'bg-blue-200 hover:bg-blue-300 text-blue-900'}`}
                                  title="Show all items"
                                >
                                  Select All
                                </button>
                                <button
                                  onClick={deselectAll}
                                  className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-300' : 'bg-gray-200 hover:bg-gray-300 text-gray-700'}`}
                                  title="Hide all items"
                                >
                                  Deselect All
                                </button>
                              </div>
                            </div>
                            
                            {plannedPurchaseCost.itemsWithPrices > 0 && (
                              <>
                                <div className={`text-3xl font-bold mb-3 ${darkMode ? 'text-blue-200' : 'text-blue-900'}`}>
                                  NT$ {plannedPurchaseCost.total.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </div>
                                
                                {Object.keys(plannedPurchaseCost.locationTotals).length > 1 && (
                                  <div className={`text-sm space-y-1 pt-3 border-t ${darkMode ? 'border-blue-800' : 'border-blue-300'}`}>
                                    <div className={`font-medium mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-800'}`}>Breakdown by location:</div>
                                    {Object.entries(plannedPurchaseCost.locationTotals)
                                      .sort((a, b) => {
                                        if (a[0] === 'Unspecified') return 1;
                                        if (b[0] === 'Unspecified') return -1;
                                        return a[0].localeCompare(b[0]);
                                      })
                                      .map(([location, data]) => (
                                        <div key={location} className={`flex justify-between ${darkMode ? 'text-blue-300' : 'text-blue-800'}`}>
                                          <span>{location === 'Unspecified' ? 'ðŸ“' : 'ðŸ›’'} {location}:</span>
                                          <span className="font-semibold">NT$ {data.cost.toFixed(0)} ({data.count} item{data.count !== 1 ? 's' : ''})</span>
                                        </div>
                                      ))}
                                  </div>
                                )}
                              </>
                            )}
                            
                            {plannedPurchaseCost.itemsWithoutPrices.length > 0 && (
                              <div className={`text-xs mt-3 pt-3 border-t ${darkMode ? 'border-blue-800 text-yellow-400' : 'border-blue-300 text-orange-700'}`}>
                                âš ï¸ {plannedPurchaseCost.itemsWithoutPrices.length} item{plannedPurchaseCost.itemsWithoutPrices.length !== 1 ? 's' : ''} missing price{plannedPurchaseCost.itemsWithoutPrices.length !== 1 ? 's' : ''}: {plannedPurchaseCost.itemsWithoutPrices.join(', ')}
                              </div>
                            )}
                          </div>
                        )}

                        {/* Remaining Items Grouped by Location */}
                        {remainingItems.length > 0 && (
                          <div className="space-y-2 mb-2">
                            {groupedByLocation.map(({ location, items }) => (
                              <div key={location} className={`border rounded-lg ${darkMode ? 'border-gray-700' : 'border-gray-300'}`}>
                                {/* Location Header - Collapsible */}
                                <button
                                  onClick={() => toggleSection(location)}
                                  className={`w-full px-4 py-3 flex items-center justify-between text-left font-semibold text-base border-b ${
                                    darkMode 
                                      ? 'bg-gray-800 border-gray-700 hover:bg-gray-750' 
                                      : location === 'Unspecified'
                                        ? 'bg-gray-100 border-gray-300 hover:bg-gray-200'
                                        : 'bg-blue-50 border-blue-200 hover:bg-blue-100'
                                  } ${collapsedSections[location] ? 'rounded-lg' : 'rounded-t-lg'}`}
                                  style={{ minHeight: '44px' }}
                                >
                                  <div className="flex items-center gap-2">
                                    <span className={
                                      darkMode
                                        ? 'text-white'
                                        : location === 'Unspecified'
                                          ? 'text-gray-700'
                                          : 'text-blue-900'
                                    }>
                                      {location === 'Unspecified' ? 'ðŸ“ ' + location : 'ðŸ›’ ' + location}
                                    </span>
                                    <span className={`text-sm font-normal ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                      ({items.length} item{items.length !== 1 ? 's' : ''})
                                    </span>
                                  </div>
                                  <ChevronDown className={`w-5 h-5 transition-transform ${collapsedSections[location] ? '' : 'transform rotate-180'} ${
                                    darkMode ? 'text-gray-400' : 'text-gray-600'
                                  }`} />
                                </button>

                                {/* Location Items */}
                                {!collapsedSections[location] && (
                                  <div className="p-2 space-y-1">
                                    {items.map((ingredient, index) => (
                                      <div key={index} className={`relative py-1.5 px-2 rounded border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200'}`}>
                                        {/* Single compact row: Checkboxes + Name/Amount + Plan to Buy toggle */}
                                        <div className="flex items-center gap-2">
                                          {/* Left: Purchased checkbox */}
                                          <input
                                            type="checkbox"
                                            checked={false}
                                            onChange={() => togglePurchased(ingredient.name)}
                                            className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0"
                                            style={{ minWidth: '20px', minHeight: '20px' }}
                                          />
                                          
                                          {/* Middle: Ingredient name and amount - compact inline */}
                                          <div className="flex-1 min-w-0" style={{ lineHeight: '1.3' }}>
                                            <span className={`font-semibold text-base ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                              {ingredient.name}
                                            </span>
                                            {ingredient.isQuickAdd && (
                                              <span className={`text-xs ml-1.5 px-1.5 py-0.5 rounded ${darkMode ? 'bg-green-900 text-green-300' : 'bg-green-100 text-green-700'}`}>
                                                âš¡
                                              </span>
                                            )}
                                            <span className={`font-normal text-base ml-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                              {ingredient.hasQuantity 
                                                ? `${formatAmount(ingredient.total)} ${ingredient.unit}`
                                                : 'As needed'
                                              }
                                            </span>
                                          </div>
                                          
                                          {/* Right: $ toggle + Plan to Buy toggle */}
                                          <button
                                            onClick={() => {
                                              setExpandedPriceInputs(prev => {
                                                const newSet = new Set(prev);
                                                if (newSet.has(ingredient.name)) {
                                                  newSet.delete(ingredient.name);
                                                } else {
                                                  newSet.add(ingredient.name);
                                                }
                                                return newSet;
                                              });
                                            }}
                                            className={`p-1.5 rounded transition-colors flex-shrink-0 ${
                                              expandedPriceInputs.has(ingredient.name)
                                                ? darkMode 
                                                  ? 'bg-yellow-600 text-white hover:bg-yellow-700' 
                                                  : 'bg-yellow-500 text-white hover:bg-yellow-600'
                                                : darkMode
                                                  ? 'bg-gray-600 text-gray-400 hover:bg-gray-500'
                                                  : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                                            }`}
                                            style={{ minWidth: '32px', minHeight: '32px', padding: '6px' }}
                                            title={expandedPriceInputs.has(ingredient.name) ? "Hide price entry" : "Show price entry"}
                                          >
                                            <DollarSign className="w-4 h-4" />
                                          </button>
                                          <button
                                            onClick={() => togglePlanToBuy(ingredient.name)}
                                            className={`p-1.5 rounded transition-colors flex-shrink-0 ${
                                              planToBuyItems.has(ingredient.name)
                                                ? darkMode 
                                                  ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                                  : 'bg-blue-500 text-white hover:bg-blue-600'
                                                : darkMode
                                                  ? 'bg-gray-600 text-gray-400 hover:bg-gray-500'
                                                  : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                                            }`}
                                            style={{ minWidth: '32px', minHeight: '32px', padding: '6px' }}
                                            title={planToBuyItems.has(ingredient.name) ? "Remove from planned purchase" : "Add to planned purchase"}
                                          >
                                            <ShoppingBag className="w-4 h-4" />
                                          </button>
                                        </div>

                                        {/* Package-based price entry row - collapsible per ingredient */}
                                        {expandedPriceInputs.has(ingredient.name) && (
                                        <div className="mt-1.5" style={{ lineHeight: '1.3' }}>
                                          {/* Recipe amount needed - subtle reference */}
                                          {ingredient.hasQuantity && (
                                            <div className={`text-xs mb-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                              Need: {formatAmount(ingredient.total)} {ingredient.unit}
                                            </div>
                                          )}
                                          
                                          {/* Price entry fields - all independent and always enabled */}
                                          <div className="flex items-center gap-1 flex-wrap" style={{ lineHeight: '1.2' }}>
                                            <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>NT$</span>
                                            <input
                                              type="number"
                                              value={ingredientPrices[ingredient.name]?.price ?? ''}
                                              onChange={(e) => {
                                                const newPrices = {...ingredientPrices};
                                                const value = e.target.value === '' ? null : parseFloat(e.target.value);
                                                
                                                if (!newPrices[ingredient.name]) {
                                                  newPrices[ingredient.name] = {};
                                                }
                                                
                                                newPrices[ingredient.name] = {
                                                  ...newPrices[ingredient.name],
                                                  price: value,
                                                  packageQuantity: newPrices[ingredient.name]?.packageQuantity ?? null,
                                                  packageUnit: newPrices[ingredient.name]?.packageUnit ?? ingredient.unit
                                                };
                                                
                                                setIngredientPrices(newPrices);
                                              }}
                                              placeholder="0"
                                              className={`w-14 px-1.5 py-1.5 text-sm border rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                                              style={{ fontSize: '16px' }}
                                              step="0.01"
                                              min="0"
                                            />
                                            <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>/</span>
                                            <input
                                              type="number"
                                              value={ingredientPrices[ingredient.name]?.packageQuantity ?? ''}
                                              onChange={(e) => {
                                                const newPrices = {...ingredientPrices};
                                                const value = e.target.value === '' ? null : parseFloat(e.target.value);
                                                
                                                if (!newPrices[ingredient.name]) {
                                                  newPrices[ingredient.name] = {};
                                                }
                                                
                                                newPrices[ingredient.name] = {
                                                  ...newPrices[ingredient.name],
                                                  price: newPrices[ingredient.name]?.price ?? null,
                                                  packageQuantity: value,
                                                  packageUnit: newPrices[ingredient.name]?.packageUnit ?? ingredient.unit
                                                };
                                                
                                                setIngredientPrices(newPrices);
                                              }}
                                              placeholder={ingredient.hasQuantity ? formatAmount(ingredient.total) : "1"}
                                              className={`w-14 px-1.5 py-1.5 text-sm border rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                                              style={{ fontSize: '16px' }}
                                              step="1"
                                              min="0"
                                            />
                                            <input
                                              type="text"
                                              list="package-units"
                                              value={ingredientPrices[ingredient.name]?.packageUnit ?? ingredient.unit}
                                              onChange={(e) => {
                                                const newPrices = {...ingredientPrices};
                                                
                                                if (!newPrices[ingredient.name]) {
                                                  newPrices[ingredient.name] = {};
                                                }
                                                
                                                newPrices[ingredient.name] = {
                                                  ...newPrices[ingredient.name],
                                                  price: newPrices[ingredient.name]?.price ?? null,
                                                  packageQuantity: newPrices[ingredient.name]?.packageQuantity ?? null,
                                                  packageUnit: e.target.value // Don't force default if empty
                                                };
                                                
                                                setIngredientPrices(newPrices);
                                              }}
                                              placeholder={ingredient.unit}
                                              className={`w-16 px-1.5 py-1.5 text-sm border rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                                              style={{ fontSize: '16px' }}
                                            />
                                            <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>(units)</span>
                                            
                                            {/* Calculated Total - only if complete data */}
                                            {(() => {
                                              const priceData = ingredientPrices[ingredient.name];
                                              const hasPrice = priceData?.price != null && priceData.price > 0;
                                              const hasPackageQty = priceData?.packageQuantity != null && priceData.packageQuantity > 0;
                                              const hasPackageUnit = priceData?.packageUnit;
                                              // Quick Add items (hasQuantity=false) only need price
                                              // Recipe items need price, packageQty, packageUnit, and hasQuantity
                                              const isComplete = ingredient.hasQuantity 
                                                ? (hasPrice && hasPackageQty && hasPackageUnit)
                                                : hasPrice;
                                              
                                              if (isComplete) {
                                                // Convert units if necessary
                                                const convertToBaseUnit = (qty, unit) => {
                                                  const lowerUnit = unit.toLowerCase();
                                                  // Weight conversions to grams
                                                  if (lowerUnit === 'kg') return qty * 1000;
                                                  if (lowerUnit === 'æ–¤') return qty * 600; // jin
                                                  if (lowerUnit === 'lb') return qty * 453.592;
                                                  if (lowerUnit === 'oz') return qty * 28.3495;
                                                  // Volume conversions to ml
                                                  if (lowerUnit === 'l') return qty * 1000;
                                                  // Default: no conversion
                                                  return qty;
                                                };
                                                
                                                const recipeQtyBase = convertToBaseUnit(ingredient.total, ingredient.unit);
                                                const packageQtyBase = convertToBaseUnit(priceData.packageQuantity, priceData.packageUnit);
                                                
                                                const packagesNeeded = Math.ceil(recipeQtyBase / packageQtyBase); // Round up to whole packages
                                                const totalCost = packagesNeeded * priceData.price;
                                                
                                                return (
                                                  <>
                                                    <span className={`text-sm font-semibold whitespace-nowrap ml-1 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                                      = NT${totalCost.toFixed(0)}
                                                    </span>
                                                    {packagesNeeded !== 1 && (
                                                      <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                                        ({packagesNeeded} pkg{packagesNeeded !== 1 ? 's' : ''})
                                                      </span>
                                                    )}
                                                    
                                                    {/* Price change indicator */}
                                                    {lastKnownPrices[ingredient.name] && (() => {
                                                      const currentPricePerUnit = priceData.price / packageQtyBase;
                                                      const lastPriceData = lastKnownPrices[ingredient.name];
                                                      const lastPackageQtyBase = convertToBaseUnit(
                                                        lastPriceData.packageQuantity || 1,
                                                        lastPriceData.packageUnit || ingredient.unit
                                                      );
                                                      const lastPricePerUnit = lastPriceData.price / lastPackageQtyBase;
                                                      const priceDiff = currentPricePerUnit - lastPricePerUnit;
                                                      const percentDiff = ((priceDiff / lastPricePerUnit) * 100).toFixed(0);
                                                      
                                                      if (Math.abs(priceDiff) > 0.001) {
                                                        return (
                                                          <span className={`text-xs font-medium ml-1 ${priceDiff > 0 ? 'text-red-500' : 'text-green-500'}`}>
                                                            {priceDiff > 0 ? 'â†‘' : 'â†“'}{Math.abs(percentDiff)}%
                                                          </span>
                                                        );
                                                      }
                                                      return null;
                                                    })()}
                                                  </>
                                                );
                                              } else if (hasPrice || hasPackageQty) {
                                                // Partial data - show warning
                                                return (
                                                  <span className={`text-xs ml-1 ${darkMode ? 'text-yellow-500' : 'text-yellow-600'}`}>
                                                    âš  {!hasPrice ? 'Need price' : !hasPackageQty ? 'Need unit size' : 'Incomplete'}
                                                  </span>
                                                );
                                              }
                                              return null;
                                            })()}
                                          </div>
                                          
                                          {/* Unit price display when complete */}
                                          {(() => {
                                            const priceData = ingredientPrices[ingredient.name];
                                            if (priceData?.price > 0 && priceData?.packageQuantity > 0) {
                                              const unitPrice = priceData.price / priceData.packageQuantity;
                                              return (
                                                <div className={`text-xs mt-0.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                                  NT${unitPrice.toFixed(2)}/{priceData.packageUnit || ingredient.unit}
                                                </div>
                                              );
                                            }
                                            return null;
                                          })()}
                                        </div>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                        
                        {/* Unit dropdown datalist */}
                        <datalist id="package-units">
                          {packageUnits.map(unit => (
                            <option key={unit} value={unit} />
                          ))}
                        </datalist>

                        {/* Purchased Items */}
                        {purchasedItemsList.length > 0 && (
                          <>
                            <div className={`border-t pt-2 mt-2 ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                              <h3 className={`text-sm font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Purchased ({purchasedItemsList.length})</h3>
                              <div className="space-y-1">
                                {purchasedItemsList.map((ingredient, index) => (
                                  <div key={index} className={`py-1.5 px-2 rounded border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-green-50 border-green-200'}`}>
                                    {/* Compact row with strikethrough */}
                                    <div className="flex items-center gap-2">
                                      <input
                                        type="checkbox"
                                        checked={true}
                                        onChange={() => togglePurchased(ingredient.name)}
                                        className="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500 flex-shrink-0"
                                        style={{ minWidth: '20px', minHeight: '20px' }}
                                      />
                                      <div className="flex-1 min-w-0" style={{ lineHeight: '1.3' }}>
                                        <span className={`font-semibold text-base line-through ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                          {ingredient.name}
                                        </span>
                                        {ingredient.isQuickAdd && (
                                          <span className={`text-xs ml-1.5 px-1.5 py-0.5 rounded ${darkMode ? 'bg-green-900 text-green-300' : 'bg-green-100 text-green-700'}`}>
                                            âš¡
                                          </span>
                                        )}
                                        <span className={`font-normal text-base line-through ml-1.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                          {ingredient.hasQuantity 
                                            ? `${formatAmount(ingredient.total)} ${ingredient.unit}`
                                            : 'As needed'
                                          }
                                        </span>
                                        {ingredient.location && ingredient.location.trim() && (
                                          <span className={`text-sm font-normal line-through ml-1.5 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                                            â€¢ {ingredient.location}
                                          </span>
                                        )}
                                        {/* Show total cost if price was entered - inline, with package info */}
                                        {(() => {
                                          const priceData = ingredientPrices[ingredient.name];
                                          if (priceData?.price > 0 && priceData?.packageQuantity > 0 && ingredient.hasQuantity) {
                                            // Same unit conversion logic
                                            const convertToBaseUnit = (qty, unit) => {
                                              const lowerUnit = unit.toLowerCase();
                                              if (lowerUnit === 'kg') return qty * 1000;
                                              if (lowerUnit === 'æ–¤') return qty * 600;
                                              if (lowerUnit === 'lb') return qty * 453.592;
                                              if (lowerUnit === 'oz') return qty * 28.3495;
                                              if (lowerUnit === 'l') return qty * 1000;
                                              return qty;
                                            };
                                            
                                            const recipeQtyBase = convertToBaseUnit(ingredient.total, ingredient.unit);
                                            const packageQtyBase = convertToBaseUnit(priceData.packageQuantity, priceData.packageUnit || ingredient.unit);
                                            const packagesNeeded = Math.ceil(recipeQtyBase / packageQtyBase); // Round up to whole packages
                                            const totalCost = packagesNeeded * priceData.price;
                                            
                                            return (
                                              <span className={`text-sm ml-2 ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                                (NT${totalCost.toFixed(0)})
                                              </span>
                                            );
                                          }
                                          return null;
                                        })()}
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </>
                        )}

                        {/* Removed Items Section - Show items not in planToBuyItems */}
                        {(() => {
                          const removedItems = aggregatedIngredients.filter(ing => 
                            !planToBuyItems.has(ing.name) && !purchasedItems.has(ing.name)
                          );
                          
                          if (removedItems.length === 0) return null;
                          
                          return (
                            <div className={`mt-4 p-3 rounded-lg border ${darkMode ? 'bg-gray-700/30 border-gray-600' : 'bg-gray-50 border-gray-300'}`}>
                              <div className="flex items-center justify-between mb-2">
                                <div className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  ðŸ—‘ï¸ Removed Items ({removedItems.length})
                                </div>
                                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                  Click to restore
                                </div>
                              </div>
                              <div className="space-y-1">
                                {removedItems.map(item => (
                                  <button
                                    key={item.name}
                                    onClick={() => togglePlanToBuy(item.name)}
                                    className={`w-full text-left px-2 py-1 rounded text-sm transition-colors ${
                                      darkMode 
                                        ? 'hover:bg-gray-600 text-gray-400 hover:text-white' 
                                        : 'hover:bg-gray-200 text-gray-600 hover:text-gray-900'
                                    }`}
                                    title="Click to add back to shopping list"
                                  >
                                    <span className="mr-2">â†©ï¸</span>
                                    {item.name}
                                    {item.hasQuantity && (
                                      <span className={`ml-1 text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                        ({formatAmount(item.total)} {item.unit})
                                      </span>
                                    )}
                                  </button>
                                ))}
                              </div>
                            </div>
                          );
                        })()}

                        <div className={`mt-6 pt-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            <strong>{remainingItems.length}</strong> remaining Â· <strong>{purchasedItemsList.length}</strong> purchased
                          </div>
                          {hasPrices && totalCost > 0 && (
                            <div className={`mt-3 text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                              Estimated Total: <span className="text-blue-600">NT$ {totalCost.toLocaleString('zh-TW')}</span>
                            </div>
                          )}
                        </div>
                      </>
                    )}
                  </div>
                  </div> {/* End right column: Quick Add + Shopping List */}
                </div>
              </div>

              {/* Scroll to Top Button */}
              {showScrollTop && (
                <button
                  onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                  className={`fixed bottom-6 right-6 p-3 rounded-full shadow-lg z-50 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                  title="Scroll to top"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                  </svg>
                </button>
              )}
            </div>
          );
        }

        function RecipeForm({ recipe, recipes, darkMode, showScrollTop, onSave, onCancel }) {
          const [name, setName] = useState(recipe?.name || '');
          const [yieldUnit, setYieldUnit] = useState(recipe?.yieldUnit || 'batch');
          const [notes, setNotes] = useState(recipe?.notes || '');
          const [ingredients, setIngredients] = useState(
            recipe?.ingredients || [{ name: '', quantity: '', unit: 'g', substitution: '', price: '', location: '' }]
          );
          const [activeAutocomplete, setActiveAutocomplete] = useState(null);
          const [autocompleteQuery, setAutocompleteQuery] = useState('');
          const [selectedSuggestionIndex, setSelectedSuggestionIndex] = useState(-1);
          const [ingredientSearchQuery, setIngredientSearchQuery] = useState('');

          // Standardized units list
          const standardUnits = [
            // Weight (most common first)
            { value: 'g', label: 'g (grams)' },
            { value: 'kg', label: 'kg (kilograms)' },
            { value: 'lb', label: 'lb (pounds)' },
            { value: 'oz', label: 'oz (ounces)' },
            // Volume
            { value: 'ml', label: 'ml (milliliters)' },
            { value: 'L', label: 'L (liters)' },
            { value: 'cup', label: 'cup' },
            { value: 'Tbsp', label: 'Tbsp (tablespoon)' },
            { value: 'tsp', label: 'tsp (teaspoon)' },
            // Count
            { value: 'pcs', label: 'pcs (pieces)' },
            { value: 'bag', label: 'bag' },
            { value: 'bunch', label: 'bunch' },
            { value: 'can', label: 'can' },
            { value: 'jar', label: 'jar' },
            { value: 'bottle', label: 'bottle' },
            { value: 'box', label: 'box' },
            // Other
            { value: 'batch', label: 'batch' },
            { value: 'as needed', label: 'as needed' }
          ];

          // Get all unique ingredient names from existing recipes (lowercase)
          const existingIngredients = useMemo(() => {
            const ingredientMap = new Map();
            recipes.forEach(r => {
              r.ingredients.forEach(ing => {
                const key = ing.name.toLowerCase();
                if (key && !ingredientMap.has(key)) {
                  ingredientMap.set(key, {
                    name: key,
                    unit: ing.unit,
                    quantity: ing.quantity,
                    location: ing.location || ''
                  });
                }
              });
            });
            return Array.from(ingredientMap.values()).sort((a, b) => 
              a.name.localeCompare(b.name)
            );
          }, [recipes]);

          // Get all unique locations from existing recipes
          const existingLocations = useMemo(() => {
            const locationSet = new Set();
            recipes.forEach(r => {
              r.ingredients.forEach(ing => {
                if (ing.location && ing.location.trim()) {
                  locationSet.add(ing.location.trim());
                }
              });
            });
            return Array.from(locationSet).sort();
          }, [recipes]);

          // Filter ingredients based on current query
          const getFilteredSuggestions = (query) => {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            
            // Exact matches first, then starts with, then contains
            const exact = [];
            const startsWith = [];
            const contains = [];
            
            existingIngredients.forEach(ing => {
              if (ing.name === lowerQuery) {
                exact.push(ing);
              } else if (ing.name.startsWith(lowerQuery)) {
                startsWith.push(ing);
              } else if (ing.name.includes(lowerQuery)) {
                contains.push(ing);
              }
            });
            
            return [...exact, ...startsWith, ...contains].slice(0, 10);
          };

          // Filter and sort ingredients for display
          const displayedIngredients = useMemo(() => {
            let filtered = ingredients;
            
            // Filter by search query
            if (ingredientSearchQuery.trim()) {
              const query = ingredientSearchQuery.toLowerCase();
              filtered = ingredients.filter((ing, index) => {
                // Keep the ingredient with its original index for later reference
                ing._originalIndex = index;
                return ing.name.toLowerCase().includes(query);
              });
              
              // Only sort when searching
              // Sort with smart prioritization:
              // 1. Starts-with matches first, then contains
              // 2. Within each group: alphabetical
              // 3. Empty names always last
              return filtered.sort((a, b) => {
                if (!a.name) return 1; // Empty names go to bottom
                if (!b.name) return -1;
                
                const aLower = a.name.toLowerCase();
                const bLower = b.name.toLowerCase();
                
                const aStarts = aLower.startsWith(query);
                const bStarts = bLower.startsWith(query);
                
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                
                // If both match same way, sort alphabetically
                return aLower.localeCompare(bLower);
              });
            } else {
              // No search - preserve original order (no sorting)
              return ingredients.map((ing, index) => ({
                ...ing,
                _originalIndex: index
              }));
            }
          }, [ingredients, ingredientSearchQuery]);

          const addIngredient = () => {
            setIngredients([{ name: '', quantity: '', unit: 'g', substitution: '', price: '', location: '' }, ...ingredients]);
          };

          const removeIngredient = (index) => {
            setIngredients(ingredients.filter((_, i) => i !== index));
          };

          const updateIngredient = (index, field, value) => {
            const updated = [...ingredients];
            
            // Convert ingredient names to lowercase automatically
            if (field === 'name') {
              value = value.toLowerCase();
              updated[index] = { ...updated[index], [field]: value };
              
              // Auto-fill unit when ingredient name matches existing ingredient
              const existing = existingIngredients.find(
                ing => ing.name === value
              );
              if (existing && !updated[index].unit) {
                updated[index].unit = existing.unit;
              }
            } else {
              updated[index] = { ...updated[index], [field]: value };
            }
            
            setIngredients(updated);
          };

          const handleIngredientNameChange = (index, value) => {
            updateIngredient(index, 'name', value);
            setAutocompleteQuery(value);
            setActiveAutocomplete(index);
            setSelectedSuggestionIndex(-1);
          };

          const selectSuggestion = (index, suggestion) => {
            const updated = [...ingredients];
            updated[index] = { 
              ...updated[index], 
              name: suggestion.name,
              unit: updated[index].unit || suggestion.unit,
              location: updated[index].location || suggestion.location || ''
            };
            setIngredients(updated);
            setActiveAutocomplete(null);
            setAutocompleteQuery('');
            setSelectedSuggestionIndex(-1);
          };

          const handleKeyDown = (e, index) => {
            if (activeAutocomplete !== index) return;
            
            const suggestions = getFilteredSuggestions(autocompleteQuery);
            
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              setSelectedSuggestionIndex(prev => 
                prev < suggestions.length - 1 ? prev + 1 : prev
              );
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              setSelectedSuggestionIndex(prev => prev > 0 ? prev - 1 : -1);
            } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
              e.preventDefault();
              selectSuggestion(index, suggestions[selectedSuggestionIndex]);
            } else if (e.key === 'Escape') {
              setActiveAutocomplete(null);
              setSelectedSuggestionIndex(-1);
            }
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            
            if (!name.trim()) {
              alert('Please enter a recipe name');
              return;
            }

            const filteredIngredients = ingredients.filter(ing => ing.name.trim());
            
            if (filteredIngredients.length === 0) {
              alert('Please add at least one ingredient');
              return;
            }

            const processedIngredients = filteredIngredients.map(ing => ({
              name: ing.name.trim().toLowerCase(), // Force lowercase on save
              quantity: ing.quantity === '' ? null : parseFloat(ing.quantity),
              unit: ing.unit,
              substitution: ing.substitution?.trim() || '',
              price: ing.price === '' ? null : parseFloat(ing.price),
              location: ing.location?.trim() || ''
            })).sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically

            onSave({
              ...(recipe || {}),
              name: name.trim(),
              yieldUnit,
              notes: notes.trim(),
              ingredients: processedIngredients
            });
          };

          return (
            <div className={`min-h-screen p-4 md:p-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
              <div className="max-w-3xl mx-auto">
                <div className={`rounded-lg shadow-sm border p-6 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                  <div className="flex items-center justify-between mb-6">
                    <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                      {recipe ? 'Edit Recipe' : 'Add New Recipe'}
                    </h1>
                    <button
                      onClick={onCancel}
                      className={darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-700'}
                    >
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  <form onSubmit={handleSubmit}>
                    <div className="space-y-6">
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Recipe Name *
                        </label>
                        <input
                          type="text"
                          value={name}
                          onChange={(e) => setName(e.target.value)}
                          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          placeholder="e.g., Ayam Goreng Paste"
                          required
                        />
                      </div>

                      <div>
                        <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Yield Unit
                        </label>
                        <input
                          type="text"
                          value={yieldUnit}
                          onChange={(e) => setYieldUnit(e.target.value)}
                          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          placeholder="e.g., batch, kg, liters"
                        />
                      </div>

                      <div>
                        <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Notes (optional)
                        </label>
                        <textarea
                          value={notes}
                          onChange={(e) => setNotes(e.target.value)}
                          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          placeholder="e.g., 500g equals 30 pieces, Needs 8 hour marination"
                          rows="3"
                        />
                      </div>

                      {/* Action Buttons */}
                      <div className="flex gap-3 pt-2 pb-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}">
                        <button
                          type="submit"
                          className={`flex-1 px-6 py-3 rounded-lg font-medium ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                        >
                          {recipe ? 'Update Recipe' : 'Add Recipe'}
                        </button>
                        <button
                          type="button"
                          onClick={onCancel}
                          className={`px-6 py-3 border rounded-lg font-medium ${darkMode ? 'border-gray-600 hover:bg-gray-700 text-gray-300' : 'border-gray-300 hover:bg-gray-50'}`}
                        >
                          Cancel
                        </button>
                      </div>

                      <div>
                        <div className="flex items-center justify-between mb-2">
                          <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            Ingredients *
                          </label>
                          <button
                            type="button"
                            onClick={addIngredient}
                            className={`px-4 py-2 rounded-lg font-medium ${darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                          >
                            + Add Ingredient
                          </button>
                        </div>

                        {/* Ingredient Search Field */}
                        {ingredients.length > 5 && (
                          <div className="mb-3">
                            <input
                              type="text"
                              value={ingredientSearchQuery}
                              onChange={(e) => setIngredientSearchQuery(e.target.value)}
                              placeholder="ðŸ” Search ingredients..."
                              className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'}`}
                            />
                            {ingredientSearchQuery && (
                              <div className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Showing {displayedIngredients.length} of {ingredients.length} ingredients
                              </div>
                            )}
                          </div>
                        )}

                        <div className="space-y-3">
                          {displayedIngredients.map((ingredient) => {
                            const index = ingredient._originalIndex;
                            const suggestions = activeAutocomplete === index ? getFilteredSuggestions(autocompleteQuery) : [];
                            // Remove the temporary _originalIndex property from rendering
                            const { _originalIndex, ...cleanIngredient } = ingredient;
                            
                            return (
                              <div key={index} className={`border rounded-lg p-3 ${darkMode ? 'border-gray-700 bg-gray-700' : 'border-gray-200'}`}>
                                <div className="flex flex-col sm:flex-row gap-2 mb-2">
                                  <div className="flex-1 relative">
                                    <input
                                      type="text"
                                      value={ingredient.name}
                                      onChange={(e) => handleIngredientNameChange(index, e.target.value)}
                                      onFocus={() => {
                                        // Only show autocomplete if there's text to match
                                        if (ingredient.name.length >= 2) {
                                          setActiveAutocomplete(index);
                                          setAutocompleteQuery(ingredient.name);
                                        }
                                      }}
                                      onBlur={() => {
                                        // Delay to allow click on suggestion
                                        setTimeout(() => setActiveAutocomplete(null), 200);
                                      }}
                                      onKeyDown={(e) => handleKeyDown(e, index)}
                                      className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-bold text-lg ${darkMode ? 'bg-blue-900 border-blue-600 text-blue-100' : 'bg-blue-50 border-blue-300 text-blue-900'}`}
                                      placeholder="Ingredient name (lowercase)"
                                      autoComplete="off"
                                    />
                                    
                                    {/* Custom Autocomplete Dropdown */}
                                    {suggestions.length > 0 && (
                                      <div className={`absolute z-50 w-full mt-1 rounded-lg border-2 shadow-xl max-h-64 overflow-y-auto ${darkMode ? 'bg-gray-800 border-blue-500' : 'bg-white border-blue-400'}`}
                                        style={{
                                          top: '100%',
                                          left: 0,
                                          right: 0
                                        }}
                                      >
                                        {suggestions.map((suggestion, suggestionIndex) => (
                                          <div
                                            key={suggestionIndex}
                                            onMouseDown={(e) => {
                                              e.preventDefault(); // Prevent input blur
                                              selectSuggestion(index, suggestion);
                                            }}
                                            onTouchStart={(e) => {
                                              e.preventDefault(); // Prevent input blur
                                              selectSuggestion(index, suggestion);
                                            }}
                                            className={`px-4 py-3 cursor-pointer border-b last:border-b-0 ${
                                              suggestionIndex === selectedSuggestionIndex
                                                ? darkMode ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-900'
                                                : darkMode ? 'hover:bg-gray-700 text-white border-gray-700' : 'hover:bg-gray-50 text-gray-900 border-gray-200'
                                            }`}
                                            style={{ minHeight: '44px' }}
                                          >
                                            <div className="font-medium text-base">{suggestion.name}</div>
                                            <div className={`text-sm ${suggestionIndex === selectedSuggestionIndex ? 'text-blue-200' : darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                              {suggestion.unit} {suggestion.quantity ? `(~${suggestion.quantity})` : ''}
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                  <div className="flex gap-2">
                                    <input
                                      type="number"
                                      step="0.1"
                                      value={ingredient.quantity}
                                      onChange={(e) => updateIngredient(index, 'quantity', e.target.value)}
                                      className={`w-24 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                                      placeholder="Qty"
                                    />
                                    <select
                                      value={ingredient.unit}
                                      onChange={(e) => updateIngredient(index, 'unit', e.target.value)}
                                      className={`w-24 px-2 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                                    >
                                      {standardUnits.map((unit) => (
                                        <option key={unit.value} value={unit.value}>
                                          {unit.value}
                                        </option>
                                      ))}
                                    </select>
                                    {ingredients.length > 1 && (
                                      <button
                                        type="button"
                                        onClick={() => removeIngredient(index)}
                                        className={`p-2 rounded ${darkMode ? 'text-red-400 hover:bg-gray-600' : 'text-red-600 hover:bg-red-50'}`}
                                      >
                                        <Trash className="w-5 h-5" />
                                      </button>
                                    )}
                                  </div>
                                </div>
                                <input
                                  type="text"
                                  value={ingredient.substitution || ''}
                                  onChange={(e) => updateIngredient(index, 'substitution', e.target.value)}
                                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm mb-2 ${darkMode ? 'bg-gray-800 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                                  placeholder="Substitution (e.g., or use fresh galangal)"
                                />
                                <input
                                  type="text"
                                  value={ingredient.location || ''}
                                  onChange={(e) => updateIngredient(index, 'location', e.target.value)}
                                  list={`location-suggestions-${index}`}
                                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                                  placeholder="Purchase location (e.g., Street Market, Supermarket)"
                                />
                                <datalist id={`location-suggestions-${index}`}>
                                  {existingLocations.map((loc, i) => (
                                    <option key={i} value={loc} />
                                  ))}
                                </datalist>
                              </div>
                            );
                          })}
                        </div>
                        <p className={`text-sm mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                          Leave quantity blank for ingredients you haven't measured yet
                        </p>
                      </div>
                    </div>
                  </form>
                </div>
              </div>

              {/* Scroll to Top Button */}
              {showScrollTop && (
                <button
                  onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                  className={`fixed bottom-6 right-6 p-3 rounded-full shadow-lg z-50 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                  title="Scroll to top"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                  </svg>
                </button>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ShoppingAggregator />);
    </script>
</body>
</html>